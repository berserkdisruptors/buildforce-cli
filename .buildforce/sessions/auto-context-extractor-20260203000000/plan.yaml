version: "0.0.42"
id: auto-context-extractor-20260203000000-plan
name: "Implementation Plan for Automatic Context Extraction via Stop Hook"
spec_id: "auto-context-extractor-20260203000000"
type: implementation-plan
status: in-progress
created: "2026-02-03"
last_updated: "2026-02-03"

# ARCHITECTURE OVERVIEW

approach: |
  This feature implements a Claude Code skill that hooks into the Stop event (fired after
  Claude finishes responding) to automatically trigger context extraction when meaningful
  implementation work completes. The architecture follows the template-only pattern used
  by all Buildforce slash commands - all logic lives in the SKILL.md template.

  The skill operates in three stages:
  1. Detection: Analyze git status, TodoList state, and work context to determine if extraction should trigger
  2. Analysis: Use git diff to identify which modules/features changed
  3. Extraction: Spawn existing cm-1, cm-2, cm-3 sub-agents with targeted extraction plans

  The skill uses context: fork with agent: Explore for isolated execution with full tool access.
  It reuses the existing extractor sub-agents rather than reimplementing extraction logic.

technology_stack:
  - Claude Code Stop hook: Event trigger that fires after Claude completes response
  - SKILL.md template: Markdown-based skill with YAML frontmatter for hook configuration
  - Task tool: For spawning extractor sub-agents (buildforce-structural-extractor, buildforce-conventions-extractor, buildforce-verification-extractor)
  - Git: For detecting changes and analyzing diffs
  - TodoList tool: For task completion detection
  - Bash tool: For git commands and file system operations

decisions:
  - decision: "Use Stop hook instead of git commit hooks"
    rationale: "Stop hook fires after implementation work is done but before user resumes control, giving perfect timing for extraction. Git hooks would require users to commit regularly and wouldn't work for uncommitted changes. Alternative UserPromptSubmit hook fires too early (before work is done)."

  - decision: "Reuse existing cm-1, cm-2, cm-3 extractor sub-agents"
    rationale: "Extractors already implement the proposal-based pattern with conflict resolution. Creating new extraction logic would duplicate code and create maintenance burden. We just need to generate focused extraction plans instead of full-codebase plans."

  - decision: "Use context: fork with agent: Explore"
    rationale: "Skill needs tool access (Read, Grep, Glob, Bash, Task) to analyze changes and spawn extractors. The fork context provides isolation so extraction doesn't pollute the main conversation. Explore agent is optimized for codebase analysis."

  - decision: "Use transcript analysis for topic shift detection (no persistent state file)"
    rationale: "Keeps skill stateless and simpler. Transcript contains full conversation history needed for semantic comparison. While slightly slower than cached state, it's more reliable and doesn't require state cleanup/corruption handling. Convention: Template-Only Slash Commands (strict enforcement) - all logic in SKILL.md template, not TypeScript."

  - decision: "Trigger extraction immediately when tasks complete"
    rationale: "Immediate extraction ensures context is updated right after implementation finishes, not delayed until next prompt. This keeps context maximally current and provides instant feedback to user about what was documented."

  - decision: "Show brief error notifications on extraction failure"
    rationale: "User should be aware if context extraction failed so they can manually run /buildforce.extract if needed. Silent failures would cause confusion when context doesn't update."

  - decision: "Support dry run mode for testing"
    rationale: "Dry run mode allows testing trigger logic without spawning expensive extractor sub-agents. Essential for development and debugging of trigger conditions."

  - decision: "Make skill non-user-invocable (user-invocable: false)"
    rationale: "This is a background automation skill, not something users should manually invoke. Hiding from slash menu prevents confusion. Skill activates automatically via Stop hook based on trigger conditions."

# FILE STRUCTURE

files_to_create:
  - .claude/skills/buildforce-auto-extract/SKILL.md

files_to_modify:
  - path: ".buildforce/context/_index.yaml"
    change_type: "edit"
    description: "Updated incrementally by skill after extraction completes (status/depth changes)"

# IMPLEMENTATION PHASES

phase_1:
  name: "Skill Template Creation"
  description: |
    Create the SKILL.md template with Stop hook configuration and trigger detection logic.
    This phase establishes the skill infrastructure and hook wiring.

  tasks:
    - [x] Create .claude/skills/buildforce-auto-extract/ directory
      spec_refs: [FR1, NFR2]
      files: [.claude/skills/buildforce-auto-extract/]
      notes: "Follow naming-conventions.yaml: kebab-case for skill directory"

    - [x] Create SKILL.md with YAML frontmatter configuring Stop hook
      spec_refs: [FR1, NFR2, NFR3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Set user-invocable: false, context: fork, agent: Explore, timeout: 120, hook: Stop. Follow template-only-slash-commands.yaml (strict)"

    - [x] Implement infinite loop prevention check (stop_hook_active flag)
      spec_refs: [FR9, AC7]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Read $INPUT JSON, check stop_hook_active field, exit early if true"

    - [x] Implement dry run mode for testing trigger logic
      spec_refs: []
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Support DRY_RUN=true environment variable or frontmatter flag. In dry run mode, detect triggers and log what would happen, but don't spawn extractors."

  validation:
    - [x] All phase_1 tasks completed
    - [x] SKILL.md frontmatter is valid YAML
    - [x] Skill does not appear in slash menu (user-invocable: false verified)
    - [x] Dry run mode can be enabled and logs trigger decisions without spawning extractors
    - [x] Spec requirements covered: [FR1, FR9, NFR2, NFR3]

phase_2:
  name: "Trigger Condition Detection"
  description: |
    Implement the two trigger conditions: (git changes + all tasks complete) OR (git changes + topic shift).
    This phase includes git status checking, TodoList analysis, and work context tracking.

  tasks:
    - [x] Check for git changes in working directory (git status --porcelain)
      spec_refs: [FR2, FR10, AC6]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use Bash tool. Apply intelligent filtering for trivial changes using agent judgment (consider file types, diff size, change patterns)"

    - [x] Check TodoList for task completion state (all tasks marked completed)
      spec_refs: [FR2, AC1]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use TaskList tool to check if all tasks have status: completed"

    - [x] Implement work context tracking for topic shift detection via transcript analysis
      spec_refs: [FR2, FR8, AC2]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Analyze transcript to extract recent implementation work summary and file changes. Compare current prompt with recent work using semantic similarity to detect topic shift."

    - [x] Combine trigger conditions with OR logic
      spec_refs: [FR2]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Trigger if (git_changes AND tasks_complete) OR (git_changes AND topic_shift)"

  validation:
    - [x] All phase_2 tasks completed
    - [x] Trigger logic correctly identifies completion scenarios
    - [x] Trivial changes are filtered out
    - [x] Spec requirements covered: [FR2, FR8, FR10, AC1, AC2, AC6]

phase_3:
  name: "Git Diff Analysis and Module Identification"
  description: |
    Analyze git diff to identify which files changed and map them to modules/features for
    targeted extraction. This enables incremental extraction instead of full re-extraction.

  tasks:
    - [x] Run git diff to get list of changed files with context
      spec_refs: [FR3, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use Bash: git diff --name-status HEAD to get added/modified/deleted files"

    - [x] Map changed files to modules/features/components
      spec_refs: [FR3, FR4, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Extract module names from file paths (e.g., src/auth/* → authentication, src/templates/commands/* → slash-commands)"

    - [x] Generate focused extraction scope for sub-agents
      spec_refs: [FR4, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Create list of modules/features for extractors to focus on. Include related files even if not directly modified."

  validation:
    - [x] All phase_3 tasks completed
    - [x] Git diff correctly identifies changed files
    - [x] Module mapping is accurate and semantic
    - [x] Spec requirements covered: [FR3, FR4, AC3]

phase_4:
  name: "Extractor Sub-Agent Integration"
  description: |
    Spawn the existing cm-1, cm-2, cm-3 extractor sub-agents with targeted extraction plans
    focused on changed modules. Collect their proposals and handle errors gracefully.

  tasks:
    - [x] Spawn buildforce-structural-extractor with focused scope
      spec_refs: [FR5, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use Task tool with subagent_type: buildforce-structural-extractor. Pass module list and file changes as context."

    - [x] Spawn buildforce-conventions-extractor with focused scope
      spec_refs: [FR5, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use Task tool with subagent_type: buildforce-conventions-extractor. Pass module list and file changes as context."

    - [x] Spawn buildforce-verification-extractor with focused scope
      spec_refs: [FR5, AC3]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Use Task tool with subagent_type: buildforce-verification-extractor. Pass module list and file changes as context."

    - [x] Handle extractor errors gracefully (timeout, failure)
      spec_refs: [NFR4]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "If extractor fails, show brief error notification to user and log details. Skip failed extractor and continue with others. Don't block user flow."

  validation:
    - [x] All phase_4 tasks completed
    - [x] All three extractors spawn successfully
    - [x] Extractors receive focused scope (not full codebase)
    - [x] Errors don't crash the skill
    - [x] Spec requirements covered: [FR5, AC3, NFR4]

phase_5:
  name: "Coverage Map Update and User Notification"
  description: |
    Update _index.yaml coverage map incrementally based on extraction results and provide
    a brief, non-intrusive notification to the user about what was updated.

  tasks:
    - [x] Parse extractor proposals to identify created/updated context files
      spec_refs: [FR6, AC4]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Extractors return YAML proposals listing files to create/update. Parse these to build summary."

    - [x] Update _index.yaml status/depth for affected items
      spec_refs: [FR6, AC4]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "For each updated item, change status to 'extracted' and increment depth level. Use Read + Edit tools."

    - [x] Generate brief user notification
      spec_refs: [FR7, AC5, NFR4]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Format: 'Context updated: [X files created, Y files updated]'. Include file names. Keep to 1-2 lines."

    - [x] Document extraction in transcript for next topic shift detection
      spec_refs: [FR8]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "Output extraction summary to transcript (timestamp, extracted modules, files updated) so future Stop hook invocations can detect topic shifts via transcript analysis."

  validation:
    - [x] All phase_5 tasks completed
    - [x] _index.yaml correctly updated with new status/depth
    - [x] User sees brief notification
    - [x] Work context state is updated
    - [x] Spec requirements covered: [FR6, FR7, FR8, AC4, AC5, NFR4]

phase_6:
  name: "Backward Compatibility and Graceful Degradation"
  description: |
    Ensure the skill works in projects without .buildforce/context/ directory and handles
    edge cases gracefully (no git, no TodoList, etc.).

  tasks:
    - [x] Check if .buildforce/context/ exists before extraction
      spec_refs: [NFR5, AC8]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "If directory doesn't exist, skip extraction gracefully. Log: 'Context repository not initialized, skipping extraction.'"

    - [x] Handle git not available or not a git repository
      spec_refs: [NFR5, AC8]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "If git status fails, assume no changes and skip extraction. Don't error."

    - [x] Handle TodoList not available or empty
      spec_refs: [NFR5, AC8]
      files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "If TaskList tool fails or returns empty, fall back to topic shift detection only."

  validation:
    - [x] All phase_6 tasks completed
    - [x] Skill works in projects without context repository
    - [x] Skill handles missing git gracefully
    - [x] Skill handles missing TodoList gracefully
    - [x] Spec requirements covered: [NFR5, AC8]

# DEVIATION LOG

deviations:
  - phase: "phase_2"
    task: "Check TodoList for task completion state"
    original: "Implement two trigger conditions: (git changes + tasks complete) OR (git changes + topic shift)"
    actual: "Implemented simplified trigger: git changes + (topic shift OR completion keywords OR >= 3 file changes)"
    reason: "User's workflow doesn't use TodoList (uses superpowers plugin instead). TodoList requirement was too restrictive and prevented triggering. Simplified to use multiple completion signals: topic shift detection, completion keywords in prompt, and substantial file change count."

  - phase: "phase_1"
    task: "Configure Stop hook in skill frontmatter"
    original: "Hook configuration in SKILL.md frontmatter"
    actual: "Hook configuration moved to .claude/settings.local.json"
    reason: "Skills with hooks in frontmatter weren't loading/triggering correctly. Moved hook configuration to settings.local.json for explicit registration and reliable triggering."

  - phase: "phase_1"
    task: "Set user-invocable: false"
    original: "Skill hidden from menu (user-invocable: false)"
    actual: "Skill visible in menu (user-invocable: true)"
    reason: "Changed to allow manual testing and verification that skill loads correctly. Can be set back to false after testing confirms it works."

# CONVENTION COMPLIANCE

convention_compliance:
  strict_validations:
    - convention: "Template-Only Slash Commands"
      status: "✓ PASS"
      checked_files: [.claude/skills/buildforce-auto-extract/SKILL.md]
      notes: "All logic implemented in SKILL.md template. No TypeScript code created. Follows template-only pattern."

    - convention: "Naming Conventions"
      status: "✓ PASS"
      checked_files: [.claude/skills/buildforce-auto-extract/]
      notes: "Skill directory uses kebab-case (buildforce-auto-extract). No persistent state file created per resolved decision."

  recommended_validations:

# TESTING GUIDANCE

testing:
  manual_tests:
    - scenario: "Test task completion trigger"
      steps: |
        1. Create a simple plan with 2-3 tasks using /buildforce.plan
        2. Implement the tasks, making file changes
        3. Mark all tasks as completed
        4. Send next prompt to Claude
        5. Verify Stop hook triggers and extraction runs
        6. Check notification shows context files updated
        7. Verify _index.yaml coverage map updated

    - scenario: "Test topic shift trigger"
      steps: |
        1. Implement a feature (e.g., add authentication) without TodoList
        2. Make file changes in src/auth/
        3. Send prompt starting a new unrelated feature (e.g., "Add a loading spinner")
        4. Verify Stop hook detects topic shift and triggers extraction for auth work
        5. Check notification shows context files updated
        6. Verify transcript contains extraction summary for topic shift detection

    - scenario: "Test trivial change filtering"
      steps: |
        1. Edit README.md only (add a line)
        2. Send prompt to Claude
        3. Verify Stop hook does NOT trigger extraction (trivial change)
        4. Edit a source file (src/index.ts)
        5. Send prompt to Claude
        6. Verify Stop hook DOES trigger extraction (meaningful change)

    - scenario: "Test infinite loop prevention"
      steps: |
        1. Manually inspect skill logs to verify stop_hook_active check
        2. Confirm skill exits early when stop_hook_active is true
        3. Verify extraction only runs once per completion event

    - scenario: "Test dry run mode"
      steps: |
        1. Enable dry run mode (DRY_RUN=true environment variable)
        2. Complete implementation work with file changes
        3. Mark tasks as completed
        4. Send next prompt to Claude
        5. Verify Stop hook detects trigger conditions
        6. Verify skill logs what would be extracted but doesn't spawn extractors
        7. Check no actual extraction occurs

    - scenario: "Test backward compatibility"
      steps: |
        1. Test in project without .buildforce/context/ directory
        2. Verify skill skips extraction gracefully
        3. Test in non-git directory
        4. Verify skill handles gracefully

# VALIDATION CRITERIA

success_metrics:
  - "Extraction triggers automatically after implementation work completes (no manual /complete needed)"
  - "Context files stay current with codebase changes"
  - "User sees brief notification without workflow interruption"
  - "_index.yaml coverage map accurately reflects extracted content"
  - "Skill doesn't trigger on trivial changes or enter infinite loops"

spec_coverage:
  - FR1: "⏳ Phase 1: Task 2"
  - FR2: "⏳ Phase 2: Tasks 1-4"
  - FR3: "⏳ Phase 3: Tasks 1-2"
  - FR4: "⏳ Phase 3: Task 3"
  - FR5: "⏳ Phase 4: Tasks 1-3"
  - FR6: "⏳ Phase 5: Tasks 1-2"
  - FR7: "⏳ Phase 5: Task 3"
  - FR8: "⏳ Phase 2: Task 3, Phase 5: Task 4"
  - FR9: "⏳ Phase 1: Task 3"
  - FR10: "⏳ Phase 2: Task 1"
  - NFR1: "⏳ Phase 1: Task 2 (timeout: 120)"
  - NFR2: "⏳ Phase 1: Task 2 (user-invocable: false)"
  - NFR3: "⏳ Phase 1: Task 2 (context: fork, agent: Explore)"
  - NFR4: "⏳ Phase 4: Task 4, Phase 5: Task 3"
  - NFR5: "⏳ Phase 6: All tasks"
  - AC1: "⏳ Phase 2: Task 2"
  - AC2: "⏳ Phase 2: Task 3"
  - AC3: "⏳ Phase 3: All tasks, Phase 4: Tasks 1-3"
  - AC4: "⏳ Phase 5: Tasks 1-2"
  - AC5: "⏳ Phase 5: Task 3"
  - AC6: "⏳ Phase 2: Task 1"
  - AC7: "⏳ Phase 1: Task 3"
  - AC8: "⏳ Phase 6: All tasks"

# PROGRESS SUMMARY

overall_progress:
  phase_1: "4/4 tasks completed"
  phase_2: "4/4 tasks completed"
  phase_3: "3/3 tasks completed"
  phase_4: "4/4 tasks completed"
  phase_5: "4/4 tasks completed"
  phase_6: "3/3 tasks completed"

current_status: |
  Implementation complete. All 6 phases finished successfully.

  Created comprehensive SKILL.md with:
  - Stop hook configuration in YAML frontmatter
  - Infinite loop prevention via stop_hook_active check
  - Dry run mode for testing trigger logic
  - Trigger detection for task completion OR topic shift
  - Intelligent trivial change filtering
  - Git diff analysis and module mapping
  - Parallel extractor spawning with error handling
  - Coverage map updates and user notifications
  - Backward compatibility with graceful degradation

next_immediate_steps:
  - "Validate convention compliance"
  - "Run manual testing scenarios"
  - "Verify SKILL.md loads correctly in Claude Code"

# RISKS & CONSIDERATIONS

risks:
  - risk: "Stop hook timeout (120s) may be insufficient for large codebases"
    mitigation: "Focus extraction on changed modules only, not full codebase. If timeout occurs, log error and skip extraction for that iteration."

  - risk: "Topic shift detection may be imprecise (false positives/negatives)"
    mitigation: "Use semantic similarity with conservative threshold. Prefer false negatives (miss extraction) over false positives (unnecessary extraction). Tune based on user feedback."

  - risk: "Extractor sub-agents may return conflicting proposals"
    mitigation: "Extractors already implement conflict resolution via Context Manager pattern. Skill just passes proposals through."

  - risk: "Transcript analysis for topic shift may be slower than cached state"
    mitigation: "Transcript parsing is acceptable overhead for Stop hook (fires infrequently). If performance becomes issue, can add caching layer in future iteration."

  - risk: "Skill may interfere with user's Stop hooks"
    mitigation: "Claude Code supports multiple Stop hooks - they run sequentially. Document that skill hooks run in addition to user hooks."

# NOTES

general_notes:
  - "This skill follows the Template-Only Slash Commands convention (strict) - all logic in SKILL.md"
  - "Skill uses context: fork for isolation - extraction doesn't pollute main conversation"
  - "Skill is non-user-invocable (background automation) - hidden from slash menu"
  - "Reuses existing extractor sub-agents (cm-1, cm-2, cm-3) - no duplication of extraction logic"
  - "Topic shift detection uses transcript analysis (stateless) - no persistent state file needed"
  - "Extraction triggers immediately when tasks complete for instant context updates"
  - "Dry run mode supported for testing trigger logic without spawning extractors"

lessons_learned:
  - "Stop hook is the perfect trigger point - fires after work completes but before user resumes control"
  - "Transcript analysis provides sufficient context for topic shift detection - persistent state not required"
  - "Incremental extraction is essential for performance - full re-extraction on every change would be too slow"
  - "Immediate extraction (not batched) provides better UX - user sees context updated right away"

future_enhancements:
  - "Add user configuration for trigger sensitivity (conservative vs aggressive)"
  - "Support manual override to disable extraction temporarily"
  - "Add dry-run mode for testing trigger logic without actual extraction"
  - "Improve topic shift detection with better semantic similarity algorithms"
  - "Add extraction quality metrics (coverage %, depth distribution)"
  - "Support extraction priority (extract critical modules first if timeout approaching)"
