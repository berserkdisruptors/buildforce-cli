# Plan Template for /build Agent Execution
# This template is optimized for AI agent consumption during /build commands
# It provides checkbox-based progress tracking, deviation logging, and spec traceability

id: research-persistence-intelligent-20251027213207-plan
name: "Implementation Plan for Intelligent Research Persistence"
spec_id: "research-persistence-intelligent-20251027213207"
type: implementation-plan
status: draft
created: "2025-10-27"
last_updated: "2025-10-28"

# ARCHITECTURE OVERVIEW

approach: |
  This feature adds research persistence through a three-stage pipeline:
  1. Accumulation: /research appends to .buildforce/.research-cache.md
  2. Materialization: /spec intelligently condenses cache into research.yaml
  3. Cleanup: /complete deletes cache after finalization

  Template-based implementation (no code) modifying three commands and .gitignore.
  Key innovation is intelligent materialization - extract essentials, not verbatim copy.

technology_stack:
  - Markdown for cache log format (.research-cache.md)
  - YAML for materialized research (research.yaml)
  - Template instructions for slash commands

decisions:
  - decision: "Use markdown for cache, YAML for materialized research"
    rationale: "Markdown is append-friendly for logs and preserves diagrams/code. YAML maintains consistency with spec artifacts while allowing flexible structure."

  - decision: "Intelligent materialization preserving essential artifacts"
    rationale: "Balances condensation with information preservation. Extract key findings but preserve diagrams, data models, code snippets, TLDR - these are critical for /build context. Not verbatim copy, but not overly lossy either."

  - decision: "Cache only accumulates before spec creation"
    rationale: "Enforces 1:1 research-spec relationship using .current-spec state."

  - decision: "Gitignore cache, commit research.yaml"
    rationale: "Cache is temporary working file. research.yaml is versioned spec artifact."

# FILE STRUCTURE

files_to_create:
  - src/templates/research-template.yaml

files_to_modify:
  - path: "src/templates/commands/research.md"
    change_type: "edit"
    description: "Add append logic for .research-cache.md with session metadata"

  - path: "src/templates/commands/spec.md"
    change_type: "edit"
    description: "Add materialization logic in CREATE (Step 2c) and UPDATE (Step 3) modes"

  - path: "src/templates/commands/complete.md"
    change_type: "edit"
    description: "Add cleanup logic to delete .research-cache.md"

  - path: ".gitignore"
    change_type: "edit"
    description: "Add .buildforce/.research-cache.md to gitignore"

# IMPLEMENTATION PHASES

phase_1:
  name: "Define Research Artifacts Structure"
  description: |
    Define structures for .research-cache.md (log format) and research.yaml (materialized format).
    Create flexible template file that preserves information richness (diagrams, models, snippets).
    Reference current /research output structure from research.md template.

  tasks:
    - [x] Review current /research output structure to understand sections that must be preserved
      spec_refs: [FR3, FR5]
      files: [src/templates/commands/research.md]
      notes: "Understand sections: Research Summary, Project Context, Codebase Findings, External Knowledge, TLDR, diagrams, data models"

    - [x] Define cache log format with session separators, timestamps, research type, preserving all content
      spec_refs: [FR1, FR2, FR3]
      files: [src/templates/research-template.yaml]
      notes: "Format: === separator, timestamp, type (research_command|freeform_context), full content with diagrams/models/snippets"

    - [x] Create flexible research.yaml template structure with optional sections and preservation guidance
      spec_refs: [FR5, FR9, FR11, FR12, AC4, AC11]
      files: [src/templates/research-template.yaml]
      notes: "Sections: summary, key_findings, file_paths, mermaid_diagrams, data_models, code_snippets, architectural_decisions, external_references, tldr. Mark sections as OPTIONAL."

    - [x] Document materialization strategy emphasizing preservation of diagrams, models, snippets, TLDR
      spec_refs: [FR5, NFR1, AC4]
      files: [src/templates/research-template.yaml]
      notes: "Explain intelligent condensation: preserve structure, diagrams, models, code - essential for /build context. Not verbatim, but preserve info-rich elements."

    - [x] Add template comments explaining flexible structure (not all sections required)
      spec_refs: [FR12, AC11]
      files: [src/templates/research-template.yaml]
      notes: "Clarify template is guidance, not enforcement. Adapt sections to research content type."

  validation:
    - [ ] All phase_1 tasks completed
    - [ ] research-template.yaml exists in src/templates/
    - [ ] Template structure is flexible with optional sections
    - [ ] Preservation guidance for diagrams/models/snippets is clear
    - [ ] Cache format preserves all content types
    - [ ] Spec requirements covered: [FR1, FR2, FR3, FR5, FR9, FR11, FR12, AC4, AC11, NFR1]

phase_2:
  name: "Update /research Command Template"
  description: |
    Modify research.md to append full structured output (including diagrams, models, snippets, TLDR)
    to .research-cache.md with session metadata.

  tasks:
    - [x] Add persistence instructions at end of research.md template after 'Next Steps' section
      spec_refs: [FR1, AC1]
      files: [src/templates/commands/research.md]
      notes: "Emphasize appending COMPLETE output - all sections, diagrams, data models, code snippets, TLDR"

    - [x] Specify cache format: session separator, timestamp, type, full structured content
      spec_refs: [FR3, AC1, AC2]
      files: [src/templates/commands/research.md]
      notes: "Use Write tool with append mode. Preserve ALL sections: Research Summary, Project Context, Codebase Findings, External Knowledge, TLDR, diagrams, models"

    - [x] Add check if cache should accumulate (no .current-spec exists)
      spec_refs: [FR10]
      files: [src/templates/commands/research.md]
      notes: "If .current-spec exists, skip cache append (research should merge with existing research.yaml)"

  validation:
    - [ ] All phase_2 tasks completed
    - [ ] research.md includes append instructions preserving all content types
    - [ ] Cache format matches phase_1 definition with full content preservation
    - [ ] Instructions emphasize NOT to truncate or summarize during append
    - [ ] Spec requirements covered: [FR1, FR3, FR10, AC1, AC2]

phase_3:
  name: "Update /spec Command - CREATE Mode (Materialization + Consumption)"
  description: |
    Add materialization logic to parse cache and create research.yaml preserving essential artifacts.
    Add consumption logic to read research.yaml when populating spec.yaml for context-aware requirements.

  tasks:
    - [x] Add Step 2c for research materialization after script execution
      spec_refs: [FR4, AC3]
      files: [src/templates/commands/spec.md]
      notes: "Insert after 'Step 2b: Run script to create folder and files'"

    - [x] Add logic to check if .research-cache.md exists
      spec_refs: [FR8, AC7]
      files: [src/templates/commands/spec.md]
      notes: "If not exists: log info and proceed. If exists: read and parse."

    - [x] Add intelligent materialization instructions referencing .buildforce/templates/research-template.yaml
      spec_refs: [FR5, FR11, NFR1, AC3, AC4, AC10]
      files: [src/templates/commands/spec.md]
      notes: "Instruct agent to read .buildforce/templates/research-template.yaml for structure guidance. Analyze cache, preserve: summary, key findings, file paths, mermaid diagrams, data models, code snippets, architectural decisions, external refs, TLDR."

    - [x] Emphasize preservation of information-rich elements during materialization
      spec_refs: [FR5, AC4]
      files: [src/templates/commands/spec.md]
      notes: "Explicitly state: DO NOT truncate diagrams, data models, or code snippets. These are essential for /build. Condense prose, preserve artifacts."

    - [x] Add instruction to write research.yaml to specs/{folder}/ with flexible structure
      spec_refs: [FR4, FR9, FR12, AC9]
      files: [src/templates/commands/spec.md]
      notes: "Use Write tool. Follow template structure but allow optional sections based on content. Not all research has diagrams - adapt accordingly."

    - [x] Add instruction to read research.yaml after materialization to inform spec.yaml population
      spec_refs: [FR13, AC14]
      files: [src/templates/commands/spec.md]
      notes: "In Step 2d (Populate spec.yaml), instruct agent to read research.yaml (if exists) to inform requirement identification, scope definition, and open_questions population with research context."

  validation:
    - [ ] All phase_3 tasks completed
    - [ ] Step 2c added for materialization
    - [ ] Step 2d enhanced to consume research.yaml
    - [ ] Materialization logic references template
    - [ ] Preservation of diagrams/models/snippets is explicit
    - [ ] Research consumption for spec population is clear
    - [ ] Spec requirements covered: [FR4, FR5, FR8, FR9, FR11, FR12, FR13, NFR1, AC3, AC4, AC7, AC9, AC10, AC14]

phase_4:
  name: "Update /spec Command - UPDATE Mode (Merging + Consumption)"
  description: |
    Add intelligent merging so new research merges with existing research.yaml preserving
    information. Add consumption logic to read research.yaml when updating spec.yaml.

  tasks:
    - [x] Add logic to check if research.yaml exists in spec folder
      spec_refs: [FR6, FR13]
      files: [src/templates/commands/spec.md]
      notes: "In Step 3 (UPDATE mode), after loading spec.yaml and plan.yaml"

    - [x] Add instruction to read research.yaml to inform spec.yaml updates
      spec_refs: [FR13, AC14]
      files: [src/templates/commands/spec.md]
      notes: "Before analyzing user input, read research.yaml (if exists) to maintain context consistency and inform requirement updates"

    - [x] Add logic to check if new cache exists (.research-cache.md)
      spec_refs: [FR6]
      files: [src/templates/commands/spec.md]
      notes: "If cache exists, new research was conducted after spec creation"

    - [x] Add intelligent merge instructions preserving information richness
      spec_refs: [FR6, AC5]
      files: [src/templates/commands/spec.md]
      notes: "Parse cache, compare with existing research.yaml. Append new findings with 'UPDATE: [date]' separator. Preserve new diagrams, models, snippets. Don't duplicate existing content."

  validation:
    - [ ] All phase_4 tasks completed
    - [ ] UPDATE mode includes merge logic
    - [ ] UPDATE mode includes research.yaml consumption
    - [ ] Merge prevents duplication while preserving new artifacts
    - [ ] Spec requirements covered: [FR6, FR13, AC5, AC14]

phase_5:
  name: "Update /complete Command Template (Consumption + Cleanup)"
  description: |
    Add logic to read research.yaml for context enrichment when creating context files.
    Add cleanup logic to delete .research-cache.md after spec finalization.

  tasks:
    - [x] Add instruction to read research.yaml in Step 3 (Analyze context requirements)
      spec_refs: [FR15, AC16]
      files: [src/templates/commands/complete.md]
      notes: "After reading spec.yaml and plan.yaml, check if research.yaml exists. If yes, read it to extract research findings (file paths, architectural patterns, design decisions) for context file enrichment."

    - [x] Add cleanup step after context file creation (Step 9)
      spec_refs: [FR7, AC6]
      files: [src/templates/commands/complete.md]
      notes: "After updating _index.yaml, before completion summary"

    - [x] Add instruction to check if .research-cache.md exists
      spec_refs: [FR7]
      files: [src/templates/commands/complete.md]
      notes: "Use Bash tool to check existence, delete if present"

    - [x] Add note that materialized research preserved in research.yaml
      spec_refs: [AC9]
      files: [src/templates/commands/complete.md]
      notes: "Explain cache cleaned but research.yaml remains as artifact"

  validation:
    - [ ] All phase_5 tasks completed
    - [ ] Research.yaml consumption added for context enrichment
    - [ ] Cleanup logic added to complete.md
    - [ ] Cache deletion is conditional
    - [ ] Spec requirements covered: [FR7, FR15, AC6, AC9, AC16]

phase_6:
  name: "Update /build Command Template"
  description: |
    Add logic to load research.yaml alongside spec.yaml and plan.yaml for implementation context.

  tasks:
    - [x] Add instruction to load research.yaml in artifact loading section
      spec_refs: [FR14, AC15]
      files: [src/templates/commands/build.md]
      notes: "In 'Loading Spec Artifacts' section, add explicit instruction to check if specs/{folder}/research.yaml exists. If yes, read it alongside spec.yaml and plan.yaml for comprehensive implementation context including diagrams, models, code snippets, architectural decisions."

    - [x] Emphasize research.yaml provides critical context for implementation
      spec_refs: [FR14]
      files: [src/templates/commands/build.md]
      notes: "Explain research.yaml contains: file paths discovered, mermaid diagrams (architecture flows), data models (properties/types), code snippets (examples/patterns), TLDR - essential for informed implementation."

  validation:
    - [ ] All phase_6 tasks completed
    - [ ] research.yaml loading added to artifact loading instructions
    - [ ] Purpose and contents of research.yaml clearly explained
    - [ ] Spec requirements covered: [FR14, AC15]

phase_7:
  name: "Update .gitignore"
  description: |
    Add .research-cache.md to gitignore to prevent version control pollution.

  tasks:
    - [x] Add .buildforce/.research-cache.md to .gitignore
      spec_refs: [NFR3, AC8]
      files: [.gitignore]
      notes: "Add below .buildforce/.current-spec entry"

  validation:
    - [ ] All phase_7 tasks completed
    - [ ] .gitignore updated
    - [ ] Spec requirements covered: [NFR3, AC8]

phase_8:
  name: "Verify Template Structure and Distribution"
  description: |
    Verify all modified templates maintain proper structure, follow conventions, and that
    research-template.yaml will be automatically distributed via existing release packaging.

  tasks:
    - [x] Verify research.md template follows existing command patterns
      spec_refs: [AC12]
      files: [src/templates/commands/research.md]
      notes: "Check formatting, instruction clarity, tool usage"

    - [x] Verify spec.md template maintains workflow step numbering
      spec_refs: [AC12]
      files: [src/templates/commands/spec.md]
      notes: "Ensure Step 2c doesn't break existing step flow"

    - [x] Verify complete.md cleanup step is correctly positioned
      spec_refs: [AC12]
      files: [src/templates/commands/complete.md]
      notes: "Cleanup before completion summary"

    - [x] Verify research-template.yaml exists in src/templates/ (will be auto-packaged)
      spec_refs: [FR11, AC10, AC13]
      files: [src/templates/research-template.yaml, .github/workflows/scripts/create-release-packages.sh]
      notes: "Confirm file exists. Verify lines 115-127 of create-release-packages.sh will copy it (no code changes needed)"

    - [x] Test edge cases: empty cache, malformed cache, missing cache
      spec_refs: [NFR4]
      files: [src/templates/commands/spec.md]
      notes: "Ensure graceful handling of edge cases"

  validation:
    - [ ] All phase_7 tasks completed
    - [ ] All templates properly structured
    - [ ] research-template.yaml will be automatically packaged and distributed
    - [ ] Edge cases handled gracefully
    - [ ] Spec requirements covered: [FR11, AC10, AC12, AC13, NFR4]

# DEVIATION LOG

deviations:
  # Build agent will populate during implementation

# TESTING GUIDANCE

testing:
  automated_tests:
    - test_file: "N/A (template-only changes)"
      what: "No automated tests for template modifications"
      command: "Manual testing required"

  manual_tests:
    - scenario: "Test research cache accumulation"
      steps: |
        1. Run /research with query
        2. Verify .buildforce/.research-cache.md created with session metadata
        3. Run /research again with different query
        4. Verify cache appends with new session separator
        5. Check cache format: separators, timestamps, type=research_command

    - scenario: "Test research materialization in CREATE mode"
      steps: |
        1. Ensure .research-cache.md exists with content
        2. Run /spec to create new spec
        3. Verify specs/{folder}/research.yaml created
        4. Verify research.yaml is condensed (not verbatim copy)
        5. Check research.yaml structure: summary, key_findings, file_paths, architectural_decisions, external_references

    - scenario: "Test spec creation without research cache"
      steps: |
        1. Delete .research-cache.md if exists
        2. Run /spec to create new spec
        3. Verify info message displayed (not error)
        4. Verify spec.yaml and plan.yaml created successfully
        5. Verify no research.yaml created (graceful degradation)

    - scenario: "Test research merge in UPDATE mode"
      steps: |
        1. Create spec with research.yaml
        2. Run /research with new query
        3. Verify cache accumulates new research
        4. Run /spec to update existing spec
        5. Verify research.yaml updated with new findings
        6. Check for duplication (should not duplicate)

    - scenario: "Test cache cleanup on /complete"
      steps: |
        1. Ensure .research-cache.md exists
        2. Run /complete to finalize spec
        3. Verify .research-cache.md deleted
        4. Verify research.yaml remains in specs/{folder}/

# VALIDATION CRITERIA

success_metrics:
  - "All command templates updated with correct instructions"
  - "Cache accumulation works for multiple research sessions"
  - "Materialization produces condensed, structured research.yaml"
  - "Cache cleanup prevents orphaned files"
  - ".gitignore prevents cache from being committed"

spec_coverage:
  - FR1: "⏳ Phase 2: Tasks 1-2"
  - FR2: "⏳ Phase 1: Task 2"
  - FR3: "⏳ Phase 1: Tasks 1-2, Phase 2: Task 2"
  - FR4: "⏳ Phase 3: Tasks 1-5"
  - FR5: "⏳ Phase 1: Tasks 1,3-4, Phase 3: Tasks 3-4"
  - FR6: "⏳ Phase 4: Tasks 1-4"
  - FR7: "⏳ Phase 5: Tasks 2-4"
  - FR8: "⏳ Phase 3: Task 2"
  - FR9: "⏳ Phase 1: Task 3, Phase 3: Task 5"
  - FR10: "⏳ Phase 2: Task 3"
  - FR11: "⏳ Phase 1: Task 3, Phase 3: Task 3"
  - FR12: "⏳ Phase 1: Tasks 3,5, Phase 3: Task 5"
  - FR13: "⏳ Phase 3: Task 6, Phase 4: Task 2"
  - FR14: "⏳ Phase 6: Tasks 1-2"
  - FR15: "⏳ Phase 5: Task 1"
  - NFR1: "⏳ Phase 1: Task 4, Phase 3: Task 3"
  - NFR2: "⏳ Phase 1: Task 3"
  - NFR3: "⏳ Phase 7: Task 1"
  - NFR4: "⏳ Phase 8: Task 5"
  - AC1: "⏳ Phase 2: Tasks 1-2"
  - AC2: "⏳ Phase 2: Task 2"
  - AC3: "⏳ Phase 3: Tasks 1,3"
  - AC4: "⏳ Phase 1: Tasks 3-4, Phase 3: Tasks 3-4"
  - AC5: "⏳ Phase 4: Task 4"
  - AC6: "⏳ Phase 5: Tasks 2-3"
  - AC7: "⏳ Phase 3: Task 2"
  - AC8: "⏳ Phase 7: Task 1"
  - AC9: "⏳ Phase 3: Task 5, Phase 5: Task 4"
  - AC10: "⏳ Phase 1: Task 3, Phase 3: Task 3, Phase 8: Task 4"
  - AC11: "⏳ Phase 1: Tasks 3,5"
  - AC12: "⏳ Phase 8: Tasks 1-3"
  - AC13: "⏳ Phase 8: Task 4"
  - AC14: "⏳ Phase 3: Task 6, Phase 4: Task 2"
  - AC15: "⏳ Phase 6: Task 1"
  - AC16: "⏳ Phase 5: Task 1"

# PROGRESS SUMMARY

overall_progress:
  phase_1: "5/5 tasks completed"
  phase_2: "3/3 tasks completed"
  phase_3: "6/6 tasks completed"
  phase_4: "4/4 tasks completed"
  phase_5: "4/4 tasks completed"
  phase_6: "2/2 tasks completed"
  phase_7: "1/1 tasks completed"
  phase_8: "5/5 tasks completed"

current_status: |
  Spec and plan created with emphasis on:
  1. Preserving information richness (diagrams, models, snippets) during materialization
  2. Ensuring consuming commands (/spec, /build, /complete) can access materialized research.yaml
  Ready for /build execution.

next_immediate_steps:
  - "Start with Phase 1: Review /research output structure from research.md"
  - "Create flexible research-template.yaml in src/templates/ with optional sections"
  - "Document preservation strategy for diagrams, data models, code snippets, TLDR"
  - "Ensure commands reference research.yaml for context-aware operation"

# RISKS & CONSIDERATIONS

risks:
  - risk: "Agents may struggle with intelligent materialization"
    mitigation: "Provide clear examples in research-template.yaml. Test with real cache content."

  - risk: "Cache format may become inconsistent"
    mitigation: "Provide explicit format with examples. Session separators make parsing resilient."

  - risk: "Large cache files (1000+ lines) may slow materialization"
    mitigation: "Acceptable - happens once per spec. Agents can handle large context."

  - risk: "Merge logic may create duplicates or miss findings"
    mitigation: "Provide clear merge instructions with examples. Test update scenarios."

  - risk: "Users may forget /research before /spec"
    mitigation: "Graceful degradation - spec proceeds with info message. Research is optional."

# NOTES

lessons_learned:
  - "Template-only implementation keeps changes simple and maintainable"
  - "Intelligent materialization prevents artifact bloat"
  - "Graceful degradation maintains workflow flexibility"

future_enhancements:
  - "Add /research-note command for explicit free-form context appending"
  - "Add validation for research.yaml structure (schema checking)"
  - "Add research.yaml to /build agent's artifact loading instructions"
  - "Consider research.yaml as input to /complete for richer context documentation"
