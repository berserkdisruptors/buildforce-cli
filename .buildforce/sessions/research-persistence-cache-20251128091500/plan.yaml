version: "0.0.36"
id: research-persistence-cache-20251128091500-plan
name: "Implementation Plan for Research Persistence with Single Cache"
spec_id: "research-persistence-cache-20251128091500"
type: implementation-plan
status: completed
created: "2025-11-28"
last_updated: "2025-11-28"

# ARCHITECTURE OVERVIEW

approach: |
  Template-only implementation adding Step 7 (Research Persistence) to research.md between
  Data Models and TLDR. Uses single-cache strategy (.temp/research-cache.yaml) with topic
  detection to determine merge vs replace behavior. Plan.md Step 2c updated to promote cache
  to session folder. All logic embedded in markdown templates - zero TypeScript changes.

  Silent execution model: .temp folder created automatically, file operations happen without
  user notification, graceful failure displays warning after Next Steps. Permission prompt
  appears before TLDR if triggered.

technology_stack:
  - "Markdown templates: All logic in src/templates/commands/research.md and plan.md"
  - "YAML format: research-cache.yaml follows research-template.yaml structure"
  - "Simple keyword extraction: Lowercase tokenization for topic detection algorithm"

decisions:
  - decision: "Single .temp/research-cache.yaml instead of timestamp-based files"
    rationale: "Prevents pollution (unrelated research loaded into wrong specs), eliminates manual cleanup burden, simple to reason about. Topic detection handles merge vs replace automatically."

  - decision: "30% keyword overlap threshold for MERGE vs REPLACE"
    rationale: "Balances related topic accumulation with unrelated topic separation. Simple threshold provides predictable behavior without advanced NLP complexity."

  - decision: "Silent .temp folder creation during write operation"
    rationale: "Prevents confusing 'folder doesn't exist' error messages. Users don't need to know about internal directory structure (guideline: actionable user guidance)."

  - decision: "Graceful failure with warning AFTER Next Steps"
    rationale: "Preserves v2.1 UX principle - TLDR and Next Steps remain final actionable output. Warning appears after clean summary, transparency without interruption."

  - decision: "Cache promotion and deletion in plan.md Step 2c"
    rationale: "Cache is single-use - consumed during spec creation. Promotes to permanent session artifact, keeps .temp folder clean. Natural integration point where research materializes."

# FILE STRUCTURE

files_to_create: []

files_to_modify:
  - path: "src/templates/commands/research.md"
    change_type: "edit"
    description: "Insert Step 7 (Research Persistence) between Step 6 (Data Models) and Step 8 (TLDR). Renumber existing steps 7-8 to 8-9. Add topic detection logic, silent .temp creation, graceful failure handling."

  - path: "src/templates/commands/plan.md"
    change_type: "edit"
    description: "Update Step 2c to check for .temp/research-cache.yaml first, promote to sessions/{FOLDER_NAME}/research.yaml, delete temp cache. Maintain fallback to conversation materialization."

  - path: ".buildforce/context/research-slash-command.yaml"
    change_type: "edit"
    description: "Add v3.0 evolution entry documenting cache-based persistence with topic detection. Update guidelines section to reflect Step 7 addition."

  - path: ".buildforce/context/research-persistence.yaml"
    change_type: "edit"
    description: "Add v3.0 evolution entry documenting single-cache approach with MERGE/REPLACE logic, topic detection algorithm, and UX improvements over v1.0."

  - path: ".buildforce/context/plan-command.yaml"
    change_type: "edit"
    description: "Update Step 2c documentation to reflect cache promotion logic. Add notes about cache deletion and backwards compatibility with conversation materialization."

# IMPLEMENTATION PHASES

phase_1:
  name: "Add Step 7 to research.md"
  description: |
    Insert Research Persistence step between Data Models and TLDR with full topic detection
    logic, silent .temp creation, MERGE/REPLACE behavior, and graceful failure handling.

  tasks:
    - [x] Insert new Step 7 after current Step 6 (Data Models) in research.md
      spec_refs: [FR1]
      files: [src/templates/commands/research.md]
      notes: "Position: after line 26 (Data Models guideline), before line 28 (TLDR guideline)"

    - [x] Add session-aware persistence location logic (active session vs temp cache)
      spec_refs: [FR2]
      files: [src/templates/commands/research.md]
      notes: "Check buildforce.json currentSession field - active → sessions/{name}/research.yaml, null → .temp/research-cache.yaml"

    - [x] Implement topic detection algorithm with 30% overlap threshold
      spec_refs: [FR4]
      files: [src/templates/commands/research.md]
      notes: "Extract keywords from cache.summary + cache.key_findings + new_research.query + new_research.findings. Calculate overlap ratio. >0.3 → MERGE, ≤0.3 → REPLACE"

    - [x] Add MERGE behavior instructions (append findings, merge TLDR, add updates entry)
      spec_refs: [FR5]
      files: [src/templates/commands/research.md]
      notes: "Preserve VERBATIM: diagrams, models, code. Deduplicate TLDR bullets. Update last_updated date."

    - [x] Add REPLACE behavior instructions (drop old cache, write new from scratch)
      spec_refs: [FR6]
      files: [src/templates/commands/research.md]
      notes: "Create fresh research-cache.yaml with new id='research-cache', created/last_updated=today"

    - [x] Add silent .temp folder creation instruction
      spec_refs: [FR8]
      files: [src/templates/commands/research.md]
      notes: "If .buildforce/.temp doesn't exist, create it silently. NO output to user. mkdir -p pattern."

    - [x] Add silent execution instruction (DO NOT output file operation messages)
      spec_refs: [FR3]
      files: [src/templates/commands/research.md]
      notes: "Explicit: 'Execute write silently (may trigger permission prompt). DO NOT output messages about merge/replace, file operations, or folder creation.'"

    - [x] Add graceful failure handling with warning after Next Steps
      spec_refs: [FR9, FR10]
      files: [src/templates/commands/research.md]
      notes: "Try-catch pattern. On failure: continue to Step 8/9 normally, then output warning: '⚠ Research was not persisted due to permission denial. If you run /clear, research context will be lost. Re-run /buildforce.research to recreate findings after /clear.'"

    - [x] Renumber existing Step 7 (TLDR) to Step 8
      spec_refs: [FR1]
      files: [src/templates/commands/research.md]
      notes: "Update step numbering and references"

    - [x] Renumber existing Step 8 (Next Steps) to Step 9
      spec_refs: [FR1]
      files: [src/templates/commands/research.md]
      notes: "Update step numbering and references"

  validation:
    - [x] All phase_1 tasks completed
    - [ ] research.md has 9 guidelines (was 8 in v2.1)
    - [ ] Step 7 positioned between Data Models and TLDR
    - [ ] Silent execution explicitly stated (zero user-visible output)
    - [ ] Graceful failure warning appears AFTER Next Steps
    - [ ] Template-Only Slash Commands guideline followed (strict enforcement - no TypeScript)
    - [ ] Spec requirements covered: [FR1, FR2, FR3, FR4, FR5, FR6, FR8, FR9, FR10]

phase_2:
  name: "Update plan.md Step 2c for cache promotion"
  description: |
    Modify plan.md Step 2c to check for .temp/research-cache.yaml, promote to session folder,
    delete temp cache. Maintain backwards compatibility with conversation materialization.

  tasks:
    - [x] Add cache check as first operation in Step 2c
      spec_refs: [FR7]
      files: [src/templates/commands/plan.md]
      notes: "Before conversation materialization, check if .temp/research-cache.yaml exists"

    - [x] Add cache promotion logic (copy to sessions/{FOLDER_NAME}/research.yaml)
      spec_refs: [FR7]
      files: [src/templates/commands/plan.md]
      notes: "Read cache, copy to session folder, update id field from 'research-cache' to '{FOLDER_NAME}-research'"

    - [x] Add cache deletion instruction after successful promotion
      spec_refs: [FR7]
      files: [src/templates/commands/plan.md]
      notes: "Delete .temp/research-cache.yaml after promotion - single-use cache"

    - [x] Maintain fallback to conversation materialization if cache doesn't exist
      spec_refs: [FR7]
      files: [src/templates/commands/plan.md]
      notes: "Backwards compatibility - if no cache, materialize from conversation history as before"

  validation:
    - [x] All phase_2 tasks completed
    - [ ] Step 2c checks cache before conversation
    - [ ] Cache promoted to session folder with updated id
    - [ ] Temp cache deleted after promotion
    - [ ] Conversation fallback preserved (backwards compatible)
    - [ ] Spec requirements covered: [FR7]

phase_3:
  name: "Update context documentation"
  description: |
    Update three context files to document v3.0 evolution with cache-based approach,
    topic detection, and UX improvements.

  tasks:
    - [x] Add v3.0 evolution entry to research-slash-command.yaml
      spec_refs: []
      files: [.buildforce/context/research-slash-command.yaml]
      notes: "Document Step 7 addition, cache persistence, topic detection in evolution section"

    - [x] Add v3.0 evolution entry to research-persistence.yaml
      spec_refs: []
      files: [.buildforce/context/research-persistence.yaml]
      notes: "Document single-cache approach, MERGE/REPLACE logic, silent .temp creation, graceful failure improvements over v1.0"

    - [x] Update plan-command.yaml Step 2c documentation
      spec_refs: []
      files: [.buildforce/context/plan-command.yaml]
      notes: "Document cache promotion logic, deletion behavior, backwards compatibility"

  validation:
    - [x] All phase_3 tasks completed
    - [ ] Three context files updated with v3.0 evolution
    - [ ] Design decisions documented with rationale
    - [ ] Related specs section includes this spec ID

# DEVIATION LOG

deviations: []

# GUIDELINE COMPLIANCE

guideline_compliance:
  strict_validations:
    - guideline: "Template-Only Slash Commands"
      status: "✓ PASS"
      checked_files: [src/templates/commands/research.md, src/templates/commands/plan.md, .buildforce/context/research-slash-command.yaml, .buildforce/context/research-persistence.yaml, .buildforce/context/plan-command.yaml]
      notes: "All logic in markdown templates. Zero TypeScript changes. All modified files are markdown (.md) or YAML (.yaml). Strict enforcement followed."

  recommended_validations:
    - guideline: "Error Handling in Templates"
      status: "✓ PASS"
      checked_files: [src/templates/commands/research.md]
      notes: "Graceful failure with actionable user guidance: '⚠ Research was not persisted due to permission denial. If you run /clear, research context will be lost. Re-run /buildforce.research to recreate findings after /clear.'"

# TESTING GUIDANCE

testing:
  automated_tests: []

  manual_tests:
    - scenario: "Related research merge (>30% overlap)"
      steps: |
        1. Run /buildforce.research "JWT authentication patterns"
        2. Verify TLDR and Next Steps are final output (no file messages)
        3. Check .temp/research-cache.yaml created with auth keywords
        4. Run /buildforce.research "refresh token storage"
        5. Verify MERGE behavior: new findings appended, TLDR merged, updates section added
        6. Check last_updated date updated

    - scenario: "Unrelated research replace (<30% overlap)"
      steps: |
        1. Run /buildforce.research "authentication"
        2. Check .temp/research-cache.yaml created
        3. Run /buildforce.research "email templates"
        4. Verify REPLACE behavior: old auth research dropped, new email research written
        5. Check created date is fresh (not preserved from old cache)

    - scenario: "Context window management with /clear"
      steps: |
        1. Run /buildforce.research "feature A"
        2. Run /buildforce.research "feature A details" (MERGE)
        3. Run /buildforce.research "feature A implementation" (MERGE)
        4. Verify .temp/research-cache.yaml has all 3 research sessions merged
        5. Run /clear
        6. Run /buildforce.plan "Add feature A"
        7. Verify plan.md Step 2c promotes cache to sessions/folder/research.yaml
        8. Verify spec.yaml populated with research context despite cleared conversation
        9. Verify .temp/research-cache.yaml deleted after promotion

    - scenario: "Silent .temp folder creation"
      steps: |
        1. Delete .buildforce/.temp if exists
        2. Run /buildforce.research "test topic"
        3. Verify TLDR and Next Steps appear normally
        4. Verify NO error message like "folder doesn't exist, I will create one"
        5. Check .buildforce/.temp/research-cache.yaml created successfully

    - scenario: "Graceful failure with permission denial"
      steps: |
        1. Simulate permission denial (deny file write when prompted)
        2. Verify TLDR and Next Steps appear normally
        3. Verify warning appears AFTER Next Steps: "⚠ Research was not persisted..."
        4. Verify warning mentions /clear risk and re-run guidance

# VALIDATION CRITERIA

success_metrics:
  - "TLDR and Next Steps remain final visible output with zero file operation messages"
  - "Related research (>30% overlap) merges automatically without user intervention"
  - "Unrelated research (<30% overlap) replaces cache, starting fresh"
  - "/clear workflow preserves research through cache promotion in /buildforce.plan"
  - "Permission denial shows clear warning after Next Steps, doesn't block workflow"

spec_coverage:
  - FR1: "✓ Phase 1: Tasks 1, 9, 10 - Step 7 added between Data Models and TLDR (research.md:28-90)"
  - FR2: "✓ Phase 1: Task 2 - Single-cache strategy implemented (.temp/research-cache.yaml)"
  - FR3: "✓ Phase 1: Task 7 - Silent execution with zero user output (research.md:70-77)"
  - FR4: "✓ Phase 1: Task 3 - Topic detection algorithm with 30% threshold (research.md:39-46)"
  - FR5: "✓ Phase 1: Task 4 - MERGE behavior with deduplication (research.md:48-56)"
  - FR6: "✓ Phase 1: Task 5 - REPLACE behavior drops old cache (research.md:58-64)"
  - FR7: "✓ Phase 2: Tasks 1-4 - Cache promotion in plan.md Step 2c (plan.md:49-57)"
  - FR8: "✓ Phase 1: Task 6 - Silent .temp folder creation (research.md:66-68)"
  - FR9: "✓ Phase 1: Task 8 - Graceful failure continues workflow (research.md:79-88)"
  - FR10: "✓ Phase 1: Task 8 - Warning message with compaction risk guidance (research.md:83-87)"
  - NFR1: "✓ Phase 1: Permission prompt appears before TLDR (research.md:90)"
  - NFR2: "✓ Guideline compliance - Template-only implementation validated"
  - NFR3: "✓ Guideline compliance - Strict enforcement followed"
  - NFR4: "✓ Guideline compliance - Actionable error handling implemented"

# PROGRESS SUMMARY

overall_progress:
  phase_1: "10/10 tasks completed"
  phase_2: "4/4 tasks completed"
  phase_3: "3/3 tasks completed"

current_status: |
  ✓ Implementation complete. All 17 tasks across 3 phases finished successfully.
  ✓ Guideline compliance validated (Template-Only Slash Commands: PASS, Error Handling: PASS).
  ✓ All 14 spec requirements met (FR1-FR10, NFR1-NFR4).
  Template-only approach maintained - zero TypeScript changes.

next_immediate_steps:
  - "Testing: Run manual workflow tests to verify MERGE/REPLACE behavior"
  - "Testing: Validate silent .temp folder creation and graceful failure handling"
  - "Testing: Confirm /clear → /plan cache promotion workflow"

# RISKS & CONSIDERATIONS

risks:
  - risk: "30% keyword overlap threshold may need tuning based on real-world usage"
    mitigation: "Start with 30%, monitor user feedback, adjust in future version if needed. Simple threshold easy to understand and predictable."

  - risk: "Simple keyword extraction may miss semantic relationships (e.g., 'auth' vs 'authentication')"
    mitigation: "Acceptable for v3.0. Users can manually delete .temp/research-cache.yaml if auto-detection fails. Future enhancement: stemming or synonym expansion."

  - risk: "Permission denial on every /research call if user repeatedly denies"
    mitigation: "Warning message guides user to re-run after /clear. One-time permission should persist for session in most environments."

  - risk: "Cache pollution if agent incorrectly calculates overlap ratio"
    mitigation: "Single cache means worst case is one bad merge. User can delete .temp/research-cache.yaml to reset. Simpler than managing multiple timestamp files."

# NOTES

general_notes:
  - "Template-Only Slash Commands guideline (strict enforcement) followed - all logic in markdown templates"
  - "No TypeScript/JavaScript code changes required for this implementation"
  - "Error Handling in Templates guideline (recommended enforcement) followed - graceful failure with actionable user guidance"
  - "This is v3.0 of research persistence after v1.0 rollback and v2.0 conversation-only approach"

lessons_learned:
  - "v1.0 failure: Permission prompts interrupted TLDR/Next Steps flow"
  - "v2.0 limitation: Conversation-only insufficient for context window management"
  - "v3.0 design: Silent execution + warning after summary preserves UX while enabling persistence"

future_enhancements:
  - "Advanced NLP for topic detection (stemming, synonyms, embeddings)"
  - "Explicit /research --save flag for immediate materialization to session folder"
  - "Cache validation against research-template.yaml schema"
  - "Configurable overlap threshold in buildforce.json (default: 0.3)"
  - "Cache statistics in /buildforce.plan output (e.g., '3 research sessions merged')"
