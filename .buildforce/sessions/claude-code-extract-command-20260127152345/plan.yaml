version: "0.0.42"
id: claude-code-extract-command-20260127152345-plan
name: "Implementation Plan for Claude Code Extract Command"
spec_id: "claude-code-extract-command-20260127152345"
type: implementation-plan
status: in-progress
created: "2026-01-27"
last_updated: "2026-01-27"

# ARCHITECTURE OVERVIEW

approach: |
  Implement the /buildforce.extract command in four phases: (1) Create the extract.md template with
  Context Manager and Miner sub-agent prompts, (2) Update template structure for v2.1 schema,
  (3) Add v2.0 → v2.1 migration logic, and (4) Update release packaging for agent-specific commands.

  The architecture follows the Template-Only Slash Commands convention - all intelligence is in the
  template, with minimal TypeScript changes limited to migration logic and release packaging scripts.

technology_stack:
  - Bash (create-release-packages.sh): Agent-specific command filtering
  - TypeScript (context-migration.ts): v2.0 → v2.1 migration logic
  - YAML (templates): Unified _index.yaml with coverage map fields
  - Markdown (extract.md): Command template with embedded sub-agent prompts

decisions:
  - decision: "Claude Code-only command via conditional release packaging"
    rationale: |
      Rather than runtime agent detection, we filter at build time. The extract.md template
      is only copied to claude packages in create-release-packages.sh. This keeps the template
      simple (no runtime checks) and ensures other agents don't see an unusable command.

  - decision: "Unified _index.yaml with domains.*.items[] arrays"
    rationale: |
      Domain-specific _index.yaml files (architecture/_index.yaml, etc.) are redundant now that
      root _index.yaml contains the full taxonomy structure. Consolidating to a single file
      reduces complexity and enables the coverage map feature where items track extraction status.

  - decision: "v2.1 as minor version (not v3.0)"
    rationale: |
      The change is additive (new fields in _index.yaml) with removals of redundant files.
      Existing context files are unaffected. Using 2.1 signals compatibility with 2.0 understanding
      while indicating the structure evolution. Backward compatible for all scenarios.

  - decision: "Sub-agent prompts embedded in extract.md, not separate files"
    rationale: |
      Following the template-only pattern, all prompts live in the single extract.md file.
      This keeps the command self-contained and makes it easy to version and update.
      Sub-agents are invoked inline with @cm-1-structural etc. syntax.

  - decision: "Parallel execution for Context Miners"
    rationale: |
      Miners run in parallel via Claude Code's Task tool for faster extraction. Context Manager
      handles coordination - miners return proposals only, CM validates and merges intelligently.
      No direct file writes by miners eliminates race conditions.

  - decision: "Ephemeral _extraction-progress.yaml files"
    rationale: |
      Progress files are deleted after each iteration completes. They serve only as communication
      between Context Manager and Miners during extraction, not as persistent state. The root
      _index.yaml is the only persistent artifact tracking extraction progress.

  - decision: "Context Manager owns all write operations and merge logic"
    rationale: |
      Miners return proposals only - they never write to context files directly. Context Manager
      receives all proposals, validates against _index.yaml, performs intelligent merging for
      conflicts, and executes all writes. This centralizes conflict resolution and ensures consistency.

# FILE STRUCTURE

files_to_create:
  - src/templates/commands/extract.md
  - src/context/_extraction-progress-template.yaml

files_to_modify:
  - path: ".github/workflows/scripts/create-release-packages.sh"
    change_type: "edit"
    description: "Add conditional logic to include extract.md only for Claude packages"

  - path: "src/commands/upgrade/context-migration.ts"
    change_type: "edit"
    description: "Add migrate21 function for v2.0 → v2.1 migration"

  - path: "src/context/_index.yaml"
    change_type: "rewrite"
    description: "Update to v2.1 schema with coverage map fields and domains.*.items[] arrays"

  - path: "src/context/architecture/_index.yaml"
    change_type: "delete"
    description: "Remove - entries migrate to root _index.yaml"

  - path: "src/context/conventions/_index.yaml"
    change_type: "delete"
    description: "Remove - entries migrate to root _index.yaml"

  - path: "src/context/verification/_index.yaml"
    change_type: "delete"
    description: "Remove - entries migrate to root _index.yaml"

# IMPLEMENTATION PHASES

phase_1:
  name: "Create Extract Command Template"
  description: |
    Create the extract.md template with Context Manager orchestration logic and embedded
    Context Miner sub-agent prompts. This is the core deliverable.

  tasks:
    - [x] Create src/templates/commands/extract.md with YAML frontmatter
      spec_refs: [FR1]
      files: [src/templates/commands/extract.md]
      notes: "Follow existing command template patterns (research.md, document.md)"

    - [x] Define Context Manager behavior in template (scan, plan, validate)
      spec_refs: [FR2, FR4, FR5]
      files: [src/templates/commands/extract.md]
      notes: "First run vs subsequent run logic; _index.yaml management"

    - [x] Define cm-1-structural sub-agent prompt
      spec_refs: [FR3, FR6]
      files: [src/templates/commands/extract.md]
      notes: "Architecture domain mining; returns proposals"

    - [x] Define cm-2-convention sub-agent prompt
      spec_refs: [FR3, FR6]
      files: [src/templates/commands/extract.md]
      notes: "Convention domain mining; returns proposals"

    - [x] Define cm-3-verification sub-agent prompt
      spec_refs: [FR3, FR6]
      files: [src/templates/commands/extract.md]
      notes: "Verification domain mining; returns proposals"

    - [x] Create _extraction-progress-template.yaml for miner coordination
      spec_refs: [FR5]
      files: [src/context/_extraction-progress-template.yaml]
      notes: "Template for per-iteration mining plans"

  validation:
    - [x] All phase_1 tasks completed
    - [x] extract.md is < 200 lines (NFR1) - 167 lines
    - [x] Sub-agent prompts are self-contained (NFR2)
    - [x] Template follows existing command patterns

phase_2:
  name: "Update Template Structure for v2.1"
  description: |
    Modify the context template structure to use v2.1 schema with unified _index.yaml
    and remove domain-specific index files.

  tasks:
    - [x] Rewrite src/context/_index.yaml with v2.1 schema
      spec_refs: [FR7]
      files: [src/context/_index.yaml]
      notes: "Add codebase_profile, domains.*.items[], summary, extraction fields"

    - [x] Remove src/context/architecture/_index.yaml
      spec_refs: [FR8]
      files: [src/context/architecture/_index.yaml]
      notes: "Entries migrate to root _index.yaml domains.structural.items[]"

    - [x] Remove src/context/conventions/_index.yaml
      spec_refs: [FR8]
      files: [src/context/conventions/_index.yaml]
      notes: "Entries migrate to root _index.yaml domains.conventions.items[]"

    - [x] Remove src/context/verification/_index.yaml
      spec_refs: [FR8]
      files: [src/context/verification/_index.yaml]
      notes: "Entries migrate to root _index.yaml domains.verification.items[]"

    - [x] Keep _schema.yaml files in domain folders
      spec_refs: [FR7]
      files: []
      notes: "_schema.yaml files remain for context file validation"

  validation:
    - [x] All phase_2 tasks completed
    - [x] Only root _index.yaml exists in templates
    - [x] Domain folders still have _schema.yaml files
    - [x] Root _index.yaml has version: "2.1"

phase_3:
  name: "Add v2.0 → v2.1 Migration"
  description: |
    Add migration logic for v2.0 → v2.1 transition. Key operation: read all entries from
    domain-specific _index.yaml files (architecture/, conventions/, verification/) and
    merge them into root _index.yaml's domains.*.items[] arrays, then delete domain indexes.
    Must handle both paths: v1.0 → v2.1 (direct) and v2.0 → v2.1 (via entry migration).

  tasks:
    - [x] Add migrate21 function to context-migration.ts
      spec_refs: [FR10, NFR3]
      files: [src/commands/upgrade/context-migration.ts]
      notes: "Detect v2.0, read domain _index.yaml contexts arrays, merge to root, delete domain indexes"

    - [x] Implement entry migration from domain _index.yaml to root _index.yaml
      spec_refs: [FR8, NFR4]
      files: [src/commands/upgrade/context-migration.ts]
      notes: "architecture/_index.yaml.contexts → root.domains.structural.items[], etc."

    - [x] Update main migration orchestration for both paths
      spec_refs: [FR10, NFR5]
      files: [src/commands/upgrade/context-migration.ts]
      notes: "v1.0 → v2.1 direct (no domain indexes exist); v2.0 → v2.1 (migrate then delete)"

    - [x] Ensure migration preserves context file contents
      spec_refs: [NFR4]
      files: [src/commands/upgrade/context-migration.ts]
      notes: "Only index structure changes, actual .yaml files in domain folders untouched"

    - [x] Make migration idempotent with entry count verification
      spec_refs: [NFR3]
      files: [src/commands/upgrade/context-migration.ts]
      notes: "Check version before migrating; verify entry counts match before/after; skip if already 2.1"

  validation:
    - [x] All phase_3 tasks completed
    - [x] Running upgrade twice produces same result (idempotent check in migrate21)
    - [x] v1.0 projects upgrade to v2.1 correctly (no domain indexes to migrate)
    - [x] v2.0 projects upgrade to v2.1 correctly (entries migrated, domain indexes deleted)
    - [x] Context files (*.yaml in domain folders) unchanged after migration
    - [x] Entry count in root _index.yaml matches sum of domain _index.yaml entry counts

phase_4:
  name: "Update Release Packaging"
  description: |
    Modify create-release-packages.sh to conditionally include extract.md
    only for Claude Code packages.

  tasks:
    - [x] Add agent-specific command filtering in generate_commands()
      spec_refs: [FR9]
      files: [.github/workflows/scripts/create-release-packages.sh]
      notes: "Check if template is agent-specific; skip for non-matching agents"

    - [x] Mark extract.md as Claude Code-only in frontmatter
      spec_refs: [FR9]
      files: [src/templates/commands/extract.md]
      notes: "Add agents: [claude] field to YAML frontmatter"

    - [x] Test packaging produces correct ZIP contents
      spec_refs: [AC6]
      files: []
      notes: "Tested locally - code path verified; full CI test on Linux required"

  validation:
    - [x] All phase_4 tasks completed
    - [x] Claude packages include extract.md (agents: [claude] field added)
    - [x] Non-Claude packages exclude extract.md (filtering logic in generate_commands)
    - [x] Other commands unaffected (no agents field = included in all packages)

# DEVIATION LOG

deviations:
  - original: "Sub-agents invoked via @cm-X-domain syntax"
    actual: "Sub-agents invoked via Task tool with subagent_type: Explore"
    reason: "Claude Code uses Task tool for sub-agents, not @ syntax. Updated template to reflect actual Claude Code capabilities."

# CONVENTION COMPLIANCE

convention_compliance:
  strict_validations:
    - convention: "Template-Only Slash Commands"
      status: "✓ PASS"
      checked_files: [src/templates/commands/extract.md]
      notes: "Extract command implemented as markdown template, no TypeScript handlers"

    - convention: "Bash Script Context Loading"
      status: "✓ PASS"
      checked_files: [.github/workflows/scripts/create-release-packages.sh]
      notes: "No runtime bash script changes, only release packaging updates"

  recommended_validations:
    - convention: "Context Repository Pattern"
      status: "✓ PASS"
      checked_files: [src/context/_index.yaml]
      notes: "Updated to v2.1 schema with unified coverage map"

    - convention: "Template-Only Changes Preferred"
      status: "✓ PASS"
      checked_files: [src/templates/commands/extract.md, src/commands/upgrade/context-migration.ts]
      notes: "Primary deliverable is template; TypeScript limited to migration logic only"

# TESTING GUIDANCE

testing:
  automated_tests:
    - test_file: "Manual inspection"
      what: "Verify ZIP contents for agent-specific commands"
      command: "AGENTS=claude,gemini SCRIPTS=sh .github/workflows/scripts/create-release-packages.sh v0.0.99"

  manual_tests:
    - scenario: "Extract command on fresh repository"
      steps: |
        1. Create new folder with a simple TypeScript project
        2. Run buildforce init (select Claude)
        3. Run /buildforce.extract
        4. Verify _index.yaml created with discovered items
        5. Run /buildforce.extract "go deeper on authentication"
        6. Verify focused extraction updates _index.yaml

    - scenario: "Upgrade from v2.0 to v2.1"
      steps: |
        1. Use a project with v2.0 context structure
        2. Run buildforce upgrade
        3. Verify domain-specific _index.yaml files removed
        4. Verify root _index.yaml has v2.1 schema
        5. Verify context files unchanged

    - scenario: "Non-Claude agent package check"
      steps: |
        1. Build release packages for gemini
        2. Extract ZIP and list .gemini/commands/
        3. Verify extract command NOT present
        4. Verify other commands (research, plan, build) present

# VALIDATION CRITERIA

success_metrics:
  - "Extract command template created and < 200 lines"
  - "v2.1 migration works for both v1.0 and v2.0 projects"
  - "Release packaging correctly filters agent-specific commands"
  - "No regressions in existing slash commands"

spec_coverage:
  - FR1: "✓ Phase 1: Task 1 - extract.md created"
  - FR2: "✓ Phase 1: Task 2 - Context Manager behavior defined"
  - FR3: "✓ Phase 1: Tasks 3-5 - All three miner prompts defined"
  - FR4: "✓ Phase 1: Task 2 - First run creates _index.yaml with discovered items"
  - FR5: "✓ Phase 1: Tasks 2,6 - Mining plans generated per iteration"
  - FR6: "✓ Phase 1: Tasks 3-5 - Miners return proposals for validation"
  - FR7: "✓ Phase 2: Task 1 - Root _index.yaml serves as coverage map"
  - FR8: "✓ Phase 2: Tasks 2-4 - Domain _index.yaml files removed"
  - FR9: "✓ Phase 4: Tasks 1-3 - Agent-specific filtering in packaging"
  - FR10: "✓ Phase 3: Tasks 1-2 - migrate21 function added"
  - FR11: "✓ Phase 2: Task 1 - v2.1 schema for new projects"
  - NFR1: "✓ Phase 1: Validation - extract.md is 167 lines (< 200)"
  - NFR2: "✓ Phase 1: Tasks 3-5 - Sub-agent prompts self-contained"
  - NFR3: "✓ Phase 3: Task 5 - Migration is idempotent"
  - NFR4: "✓ Phase 3: Task 4 - Context files preserved during migration"
  - NFR5: "✓ Phase 3: Task 3 - v1.0 → v2.1 backward compatible"

# PROGRESS SUMMARY

overall_progress:
  phase_1: "6/6 tasks completed"
  phase_2: "5/5 tasks completed"
  phase_3: "5/5 tasks completed"
  phase_4: "3/3 tasks completed"

current_status: |
  Implementation complete. All 19 tasks across 4 phases completed.
  TypeScript compiles without errors. Convention compliance validated.
  Ready for manual testing and CI validation.

next_immediate_steps:
  - "Run manual test: Extract command on fresh repository"
  - "Run manual test: Upgrade from v2.0 to v2.1"
  - "Run CI to verify release packaging on Linux"

# RISKS & CONSIDERATIONS

risks:
  - risk: "Sub-agent coordination in parallel execution"
    mitigation: "Miners return proposals only, no direct writes. Context Manager centralizes all merging and writes, eliminating race conditions."

  - risk: "Migration breaks existing projects"
    mitigation: "Comprehensive testing on v1.0, v2.0 projects; idempotent design. v1.0 → v2.1 direct path avoids intermediate state issues."

  - risk: "Template exceeds 200 line limit"
    mitigation: "Compact prompt design; reference external schemas rather than inline"

  - risk: "Other agents affected by packaging changes"
    mitigation: "Explicit agent filtering via frontmatter 'agents' field; test all agent packages after changes"

  - risk: "Lost context entries during v2.0 → v2.1 migration"
    mitigation: "Migration reads all domain _index.yaml entries and merges into root _index.yaml before deletion. Verify entry count before/after."

# NOTES

general_notes:
  - "First agent-specific command sets precedent for future features"
  - "Follow Template-Only Slash Commands convention (strict enforcement)"
  - "Domain _schema.yaml files remain for context file validation"
  - "Sub-agents invoked via @cm-X-domain syntax in Claude Code"

lessons_learned:
  - "Agent-specific commands can be filtered at build time via frontmatter 'agents' field"
  - "v2.1 schema consolidates domain _index.yaml files into root, simplifying structure"
  - "Sub-agent prompts work well embedded in main template - keeps command self-contained"
  - "TypeScript migration code handles both v1.0→v2.1 and v2.0→v2.1 paths elegantly"

future_enhancements:
  - "Add extract command to other agents when they support sub-agents"
  - "GitHub Action for automated extraction on repository events"
  - "Historical context mining from PR comments (requires separate tool)"
