version: "0.0.35"
id: multi-agent-selection-20251125000000
name: "Multiple Build Agent Selection"
type: feature
status: draft
created: "2025-11-25"
last_updated: "2025-11-25"

summary: |
  Enable users to select multiple AI build agents during init and upgrade commands, allowing concurrent
  work with multiple assistants in a single project. Update buildforce.json to store agents as array
  with backward compatibility for existing single-agent configurations.

# INTENT / PROBLEM STATEMENT

problem: |
  The current init and upgrade commands only support selecting a single AI build agent, stored as a
  string in buildforce.json's aiAssistant field. Users working across multiple AI assistants (e.g.,
  Claude for coding, Copilot for documentation, Cursor for reviews) must initialize separate projects
  or manually manage agent folders, leading to fragmentation and configuration drift.

motivation: |
  Multi-agent support enables developers to leverage strengths of different AI assistants within the
  same project. Users can have Claude slash commands for spec-driven development, Copilot prompts for
  code generation, and Cursor commands for refactoring, all with shared context and session state.
  This reduces friction when switching between tools and maintains a single source of truth for
  project configuration.

# GOALS

primary_goals:
  - Enable multi-select UI during init command for choosing multiple AI agents simultaneously
  - Update buildforce.json schema to store aiAssistants as string array instead of singular aiAssistant
  - Download and extract templates for all selected agents during init/upgrade
  - Provide backward compatibility in upgrade command to migrate single aiAssistant to array

secondary_goals:
  - Support comma-separated agent list via --ai flag for non-interactive usage
  - Maintain consistent user experience with clear visual feedback for multi-agent selection
  - Preserve agent folder isolation (each agent gets dedicated folder)

# REQUIREMENTS

functional_requirements:
  - FR1: Init command must display checkbox-based multi-select UI for agent selection (replaces single-select)
  - FR2: Init command must accept multiple --ai flags (e.g., --ai claude --ai copilot --ai cursor) using Commander.js collector
  - FR3: Init command must download and extract template for each selected agent
  - FR4: buildforce.json must store selected agents in aiAssistants array field
  - FR5: Upgrade command must detect aiAssistant (singular) in buildforce.json and migrate to aiAssistants array
  - FR6: Upgrade command must support multi-agent additive override via multiple --ai flags (merges with existing, not replaces)
  - FR7: Upgrade command must download and extract templates for all configured/added agents
  - FR8: Config validation must verify all selected agents exist in AI_CHOICES dictionary and at least one agent selected
  - FR9: Both commands must display selected agents with clear visual confirmation before proceeding
  - FR10: README.md must document multi-agent selection workflow with examples for both interactive and CLI flag usage

non_functional_requirements:
  - NFR1: Backward compatibility - existing projects with aiAssistant string must upgrade seamlessly
  - NFR2: Template downloads must occur sequentially with progress tracking per agent
  - NFR3: If any agent template download fails, keep successful downloads and allow retry (partial state acceptable)
  - NFR4: UI must clearly distinguish between single-agent (legacy) and multi-agent selection modes

# SCOPE

in_scope:
  - Create selectMultipleWithCheckboxes() component in src/lib/interactive.ts using @inquirer/prompts checkbox()
  - Update BuildforceConfig interface to use aiAssistants?: string[] instead of aiAssistant?: string
  - Modify createConfigContent() and saveBuildforceConfig() to handle string arrays
  - Update init/index.ts to use multi-select UI and loop template downloads
  - Update init/setup.ts to accept and iterate over multiple agents
  - Update upgrade/index.ts to migrate single aiAssistant to array during config read
  - Update upgrade/execution.ts to loop agent folder replacements
  - Parse --ai flag to support multiple flag instances using Commander.js collector
  - Update StepTracker to show progress per agent during multi-agent downloads
  - Update README.md with multi-agent selection examples, workflow documentation, and migration guide

out_of_scope:
  - Parallel template downloads (will be sequential with progress tracking)
  - Agent-specific script type selection (all agents share single scriptType)
  - Removal/deselection of agents after initial setup (upgrade can add but not remove)
  - Agent folder cleanup when agents are deselected
  - UI for reordering selected agents
  - Different versions per agent (all agents get same template version)

# DESIGN PRINCIPLES

design_principles:
  - "Backward compatibility first - existing single-agent configs migrate transparently"
  - "Progressive enhancement - single-agent workflows remain simple, multi-agent is opt-in"
  - "Visual clarity - multi-select UI must clearly show selected agents with confirmation step"
  - "Fail-safe operations - template download failures trigger rollback to prevent partial state"
  - "Agent folder isolation - each agent maintains dedicated folder regardless of multi-agent setup"

# ACCEPTANCE CRITERIA

acceptance_criteria:
  - AC1: Running buildforce init without --ai flag shows checkbox UI with all 11 agents, user can select multiple with spacebar
  - AC2: Running buildforce init --ai claude --ai copilot --ai cursor creates project with all three agent folders
  - AC3: buildforce.json contains aiAssistants: ["claude", "copilot", "cursor"] after multi-agent init
  - AC4: Running buildforce upgrade on project with aiAssistant: "claude" migrates to aiAssistants: ["claude"] automatically
  - AC5: Running buildforce upgrade --ai copilot on migrated project ADDS copilot, resulting in ["claude", "copilot"]
  - AC6: StepTracker shows "Download template (claude)", "Download template (copilot)" sequentially during multi-agent setup
  - AC7: Template download failure for one agent keeps successful downloads, shows error for failed agent only
  - AC8: All 11 agent choices (copilot, claude, cursor, gemini, qwen, windsurf, kilocode, auggie, roo, opencode, codex) are selectable
  - AC9: Attempting to select zero agents shows validation error "At least one agent must be selected"
  - AC10: README.md includes multi-agent examples in Quick Start section and dedicated Multi-Agent Workflow subsection

# ASSUMPTIONS & DEPENDENCIES

assumptions:
  - Template ZIPs for all agents exist in GitHub releases with naming: buildforce-cli-template-{agent}-{script}.zip
  - Users want same scriptType (sh/ps) for all agents (no per-agent script customization)
  - Agent folders can coexist without conflicts (e.g., .claude/ and .github/ and .cursor/)
  - @inquirer/prompts checkbox() component supports multi-select with spacebar + arrow keys

dependencies:
  internal:
    - cli-architecture: "Depends on downloadAndExtractTemplate(), StepTracker, selectWithArrows() patterns"
    - upgrade-command: "Migration logic integrated into upgrade command config reading"
    - state-tracking: "buildforce.json structure change affects state management"
  external:
    - "@inquirer/prompts": "^7.0.0 or higher - checkbox() function for multi-select UI"

# OPEN QUESTIONS

open_questions: []

# RESOLVED QUESTIONS (from user clarification):
resolved_questions:
  - question: "Should --ai flag support multiple instances (--ai claude --ai copilot) OR comma-separated (--ai claude,copilot) OR both?"
    answer: "Multiple instances only (--ai claude --ai copilot)"
    rationale: "Commander.js naturally supports multiple flag instances. Avoids parsing complexity of comma-separated values."

  - question: "During upgrade, if user specifies --ai override with agents not in current config, should we ADD to existing or REPLACE entirely?"
    answer: "ADD to existing agents (merge behavior)"
    rationale: "More intuitive for users wanting to add agents without re-specifying existing ones. buildforce upgrade --ai copilot adds copilot while preserving claude."

  - question: "Should we validate that at least one agent is selected, or allow empty selection (no agent folders)?"
    answer: "Yes - require minimum 1 agent"
    rationale: "Prevents invalid project state with no commands. Empty selection would break workflow."

  - question: "When template download fails mid-sequence (e.g., 2/3 agents downloaded), should we keep successful downloads or rollback all?"
    answer: "Keep successful downloads (partial state)"
    rationale: "User can retry failed agents without re-downloading successful ones. Less frustrating on network issues."

# NOTES

notes: |
  Key implementation considerations:
  - Migration logic in upgrade command reads both aiAssistant (singular) and aiAssistants (plural),
    with plural taking precedence. If singular found, convert to array and save back to config.
  - Template download loop must track success/failure per agent to enable rollback on error.
  - Agent folder mapping (AGENT_FOLDER_MAP) remains unchanged - each agent still gets dedicated folder.
  - UI feedback critical: show "Selected: claude, copilot, cursor (3 agents)" before starting downloads.

  Future enhancements:
  - Agent removal/deselection workflow with folder cleanup
  - Per-agent script type customization
  - Parallel template downloads with concurrent progress bars
  - Agent priority ordering for default selection
