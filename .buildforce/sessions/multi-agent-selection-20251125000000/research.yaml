id: "multi-agent-selection-20251125000000-research"
created: "2025-11-25"
last_updated: "2025-11-25"

summary: |
  Researched the current init and upgrade command architecture to understand single-agent selection flow.
  Discovered that agent selection uses selectWithArrows() returning a single string, stored as aiAssistant
  in buildforce.json, with template download/extraction expecting a single agent value throughout the system.

key_findings:
  - "Init command uses selectWithArrows() for single-agent selection (src/commands/init/index.ts:75-79)"
  - "Upgrade command reads single aiAssistant from buildforce.json with fallback to interactive prompt (src/commands/upgrade/index.ts:48-85)"
  - "BuildforceConfig interface has aiAssistant?: string (singular) in src/types.ts:56"
  - "Template downloads expect single agent: buildforce-cli-template-{aiAssistant}-{scriptType}.zip"
  - "Interactive selection uses @inquirer/prompts select() which returns single value"
  - "11 supported AI agents: copilot, claude, cursor, gemini, qwen, windsurf, kilocode, auggie, roo, opencode, codex"
  - "Each agent has dedicated folder mapping in AGENT_FOLDER_MAP (e.g., claude: '.claude/', copilot: '.github/')"

file_paths:
  primary:
    - path: "src/types.ts"
      relevance: "Contains BuildforceConfig interface with aiAssistant field (line 56)"
    - path: "src/lib/interactive.ts"
      relevance: "Contains selectWithArrows() single-selection component (lines 10-29)"
    - path: "src/commands/init/index.ts"
      relevance: "Init command with single agent selection flow (lines 68-110)"
    - path: "src/commands/init/setup.ts"
      relevance: "Setup project with single agent template download (lines 99-112)"
    - path: "src/commands/upgrade/index.ts"
      relevance: "Upgrade command with single agent detection/override (lines 48-128)"
    - path: "src/commands/upgrade/execution.ts"
      relevance: "Upgrade execution replacing single agent folder (lines 188-209)"
    - path: "src/utils/config.ts"
      relevance: "Config management with createConfigContent() accepting single aiAssistant (lines 21-33)"
    - path: "src/config/agents.ts"
      relevance: "AI_CHOICES dictionary and AGENT_FOLDER_MAP (11 agents)"

  secondary:
    - path: "src/constants.ts"
      relevance: "Exports AI_CHOICES and SCRIPT_TYPE_CHOICES from agents.ts"
    - path: "src/lib/github.ts"
      relevance: "Template download from GitHub releases"
    - path: "src/lib/extract.ts"
      relevance: "Template extraction logic"

mermaid_diagrams:
  - title: "Current Single-Agent Selection Flow"
    description: "Shows single-agent bottlenecks in init and upgrade commands"
    diagram: |
      ```mermaid
      flowchart TD
          A[User runs init/upgrade] --> B{Init or Upgrade?}

          B -->|Init| C[Parse CLI flags]
          B -->|Upgrade| D[Read buildforce.json]

          C --> E{--ai flag provided?}
          E -->|Yes| F[Validate single agent]
          E -->|No| G[Interactive Selection]

          D --> H{--ai flag provided?}
          H -->|Yes| F
          H -->|No| I{aiAssistant in config?}
          I -->|Yes| J[Use configured agent]
          I -->|No| G

          F --> K[Single Agent Selected]
          G --> K
          J --> K

          K --> L[Download Template for Agent]
          L --> M[Extract to Project]
          M --> N[Save to buildforce.json]
          N --> O[Setup Complete]

          style K fill:#ffcccc
          style L fill:#ffcccc
          style N fill:#ffcccc
      ```

data_models:
  - name: "BuildforceConfig (Current)"
    description: "Current configuration structure with single agent"
    properties:
      - name: "sessionsFolder"
        type: "string"
        required: true
        description: "Path to specs/sessions folder"
      - name: "framework"
        type: "string"
        required: true
        description: "Framework identifier (buildforce)"
      - name: "aiAssistant"
        type: "string"
        required: false
        description: "SINGLE AI agent identifier (e.g., 'claude', 'copilot')"
      - name: "scriptType"
        type: "string"
        required: false
        description: "Script type: 'sh' or 'ps'"
      - name: "version"
        type: "string"
        required: false
        description: "CLI version"
    relationships:
      - "Used by init command to save configuration after setup"
      - "Used by upgrade command to detect existing agent selection"

  - name: "BuildforceConfig (Proposed)"
    description: "Proposed configuration structure with multiple agents"
    properties:
      - name: "sessionsFolder"
        type: "string"
        required: true
        description: "Path to specs/sessions folder"
      - name: "framework"
        type: "string"
        required: true
        description: "Framework identifier (buildforce)"
      - name: "aiAssistants"
        type: "string[]"
        required: false
        description: "ARRAY of AI agent identifiers (e.g., ['claude', 'copilot', 'cursor'])"
      - name: "scriptType"
        type: "string"
        required: false
        description: "Script type: 'sh' or 'ps'"
      - name: "version"
        type: "string"
        required: false
        description: "CLI version"
    relationships:
      - "Backward compatible with single aiAssistant through migration in upgrade command"

code_snippets:
  - title: "Current Single Agent Selection"
    language: "typescript"
    description: "Current implementation in src/commands/init/index.ts"
    code: |
      // AI assistant selection (SINGLE)
      let selectedAi: string;
      if (inputAiAssistant) {
        validateAiAssistant(inputAiAssistant, AI_CHOICES);
        selectedAi = inputAiAssistant;
      } else {
        // Use arrow-key selection interface (SINGLE)
        selectedAi = await selectWithArrows(
          AI_CHOICES,
          "Choose your AI assistant:",
          "copilot"
        );
      }

  - title: "Current selectWithArrows Implementation"
    language: "typescript"
    description: "Single-selection UI component in src/lib/interactive.ts"
    code: |
      export async function selectWithArrows(
        options: Record<string, string>,
        promptText: string = 'Select an option',
        defaultKey?: string
      ): Promise<string> {  // Returns SINGLE string
        const choices = Object.entries(options).map(([key, description]) => ({
          name: `${MINT_COLOR(key)} ${chalk.dim(`(${description})`)}`,
          value: key,
        }));

        const answer = await select({  // @inquirer/prompts select()
          message: promptText,
          choices,
          default: defaultKey,
          theme: INQUIRER_THEME,
        });

        return answer;  // SINGLE selection
      }

architectural_decisions:
  - pattern: "Single Agent Template Distribution"
    description: "Templates are distributed as individual ZIPs per agent+script combination"
    rationale: "Template naming: buildforce-cli-template-{aiAssistant}-{scriptType}.zip. Multi-agent support requires downloading multiple templates."

  - pattern: "Agent Folder Segregation"
    description: "Each AI agent gets dedicated folder (e.g., .claude/, .github/, .cursor/)"
    rationale: "Prevents credential leakage between agents. Multi-agent support means multiple folders will coexist in same project."

  - pattern: "Interactive Selection via @inquirer/prompts"
    description: "Uses @inquirer/prompts library with select() for single-choice UI"
    rationale: "Library also provides checkbox() for multi-select. Need to create new selectMultipleWithCheckboxes() component."

tldr:
  - "Current system: single agent selection stored as aiAssistant: string in buildforce.json"
  - "Key bottlenecks: selectWithArrows() returns single value, template download expects single agent, config interface uses singular field"
  - "11 agents supported with AGENT_FOLDER_MAP providing folder paths for each"
  - "Backward compatibility needed: migrate single aiAssistant to aiAssistants array in upgrade command"
  - "Multi-select requires: new checkbox UI component, loop template downloads, update BuildforceConfig interface"
  - "Template naming: buildforce-cli-template-{agent}-{script}.zip (download multiple for multi-agent)"
  - "Agent folders coexist: .claude/, .github/, .cursor/ can all exist in same project"
