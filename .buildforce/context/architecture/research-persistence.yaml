id: research-persistence
name: Research Persistence with Intelligent Materialization
type: structural
status: production
created: 2025-10-28
last_updated: "2026-01-26"

summary: |
  Conversation-based research materialization system that enables agents to create structured
  research.yaml artifacts from conversation history during /plan execution, supporting consumption
  by /build and /complete commands for context-aware operation.

responsibilities:
  - Enable agents to materialize conversation history into structured research.yaml artifacts
  - Preserve diagrams, data models, and code snippets during materialization
  - Enable /plan, /build, /complete commands to consume research context
  - Maintain flexible YAML structure adapting to research content type

dependencies:
  internal:
    - research-slash-command: "Presents research findings in conversation"
    - spec-command: "Can materialize research.yaml from conversation history for context-aware spec population"
    - build-command: "Loads research.yaml for implementation context"
    - complete-command: "Reads research.yaml for context enrichment"
    - cli-architecture: "Template distribution via GitHub Release packaging"
  external: []

files:
  primary:
    - src/templates/research-template.yaml
    - src/templates/commands/research.md
    - src/templates/commands/plan.md
  secondary:
    - src/templates/commands/build.md
    - src/templates/commands/complete.md
    - .gitignore

design_decisions:
  - decision: "Conversation-based materialization (removed cache accumulation)"
    rationale: "Prioritizes user experience over theoretical edge cases. Cache accumulation required explicit file write permissions at each /research invocation, creating significant UX friction. Conversation history provides sufficient context for materialization during /plan."

  - decision: "Intelligent materialization preserving diagrams, models, snippets"
    rationale: "Balances condensation with information richness. Mermaid diagrams, data models, code snippets are essential for /build context - preserve verbatim. Condense prose, merge TLDR bullets."

  - decision: "research.yaml as permanent spec artifact"
    rationale: "research.yaml is versioned alongside spec.yaml and plan.yaml as permanent artifact. Provides valuable context for /build and /complete without temporary cache files."

  - decision: "Flexible template structure with optional sections"
    rationale: "Not all research produces diagrams/models/code. Template adapts to content type - omit empty sections. Prevents rigid enforcement that loses information."

  - decision: "Semantic Topic Comparison (v3.1)"
    rationale: "Trust agent's native reasoning capabilities over prescriptive algorithmic calculations. LLMs can semantically compare research topics without being told how to extract keywords, count overlaps, or calculate percentages. Simplified instruction delegates comparison logic to the agent, reduces template verbosity, maintains silent execution principle, and improves robustness - semantic understanding handles synonyms and related concepts that keyword matching would miss."

  - decision: "Topic Relevance Check During Cache Promotion (v3.1)"
    rationale: "Prevent unrelated research contamination. Cache promotion in /plan blindly promoted .temp/research-cache.yaml without checking relevance - if users ran /research on topic A then /plan for topic B, cache from A polluted B's session. Topic check before promotion ensures only related research informs planning, falls back to conversation materialization for unrelated cache."

  - decision: "Template-only implementation"
    rationale: "No code changes needed. All modifications are in command templates and documentation. Maintains consistency with Buildforce CLI's architecture."

architecture_patterns:
  research_workflow: |
    /research command workflow:
    1. Gather context from project knowledge (_index.yaml), codebase, and external sources
    2. Present structured report to user with diagrams, data models, file paths, TLDR
    3. Research findings remain in conversation history (no file persistence)

  materialization_workflow: |
    /plan command workflow (when research context exists):
    1. Agent materializes conversation history into research.yaml (optional, agent-driven)
    2. Read .buildforce/templates/research-template.yaml for structure guidance
    3. Intelligent materialization from conversation:
       - PRESERVE VERBATIM: Mermaid diagrams, data models, code snippets
       - PRESERVE WITH CONTEXT: File paths (with relevance), architectural decisions (with rationale)
       - CONDENSE: Research summary prose, project context
       - MERGE: TLDR bullets if multiple research sessions
    4. Write specs/{folder}/research.yaml with flexible structure
    5. Read research.yaml to inform spec.yaml population:
       - Extract requirements from key_findings
       - Populate open_questions with research ambiguities
       - Reference architectural_decisions in design principles

  consumption_workflow: |
    /plan command:
    - Can read existing research.yaml to maintain context consistency during updates

    /build command:
    - Loads research.yaml alongside spec.yaml and plan.yaml
    - Accesses: file_paths, mermaid_diagrams, data_models, code_snippets, architectural_decisions, TLDR

    /complete command:
    - Reads research.yaml to enrich context file documentation
    - Extracts: file_paths, architectural_decisions, key_findings

materialized_format: |
  Flexible YAML structure with optional sections:

  id: "{spec-id}-research"
  created: "YYYY-MM-DD"
  last_updated: "YYYY-MM-DD"

  summary: |
    Condensed 2-4 sentence overview

  key_findings:
    - "Discovery with context"

  file_paths:  # OPTIONAL
    primary:
      - path: "src/file.ts"
        relevance: "Why this matters"

  mermaid_diagrams:  # OPTIONAL - preserved verbatim
    - title: "Architecture Flow"
      diagram: |
        ```mermaid
        graph TD
        ```

  data_models:  # OPTIONAL - preserved with structure
    - name: "ModelName"
      properties:
        - name: "prop"
          type: "string"

  code_snippets:  # OPTIONAL - preserved complete
    - title: "Example Pattern"
      code: |
        // Complete code

  architectural_decisions:  # OPTIONAL
    - pattern: "Pattern Name"
      rationale: "Why chosen"

  tldr:  # REQUIRED - merged from all sessions
    - "Critical point 1"

evolution:
  - version: "1.0"
    date: "2025-10-28"
    changes: "Initial implementation of research persistence with three-stage pipeline (accumulation, materialization, cleanup). Added cache format with session metadata, flexible research.yaml template, and consumption logic in /plan, /build, /complete commands."

  - version: "2.0"
    date: "2025-11-03"
    changes: "Removed cache accumulation mechanism to prioritize user experience. Eliminated .research-cache.md file operations that required explicit permissions at each /research invocation. Simplified to conversation-based materialization where agents create research.yaml from conversation history during /plan. Removed cache cleanup from /complete. Template-only changes with no TypeScript modifications."

  - version: "3.0"
    date: "2025-11-28"
    changes: "Implemented single-cache YAML strategy with intelligent topic detection to address context window exhaustion problem. Major additions: (1) Session-aware persistence - writes directly to active session's research.yaml or temp cache based on buildforce.json currentSession, (2) Topic detection algorithm using 30% keyword overlap threshold to determine MERGE (related topics) vs REPLACE (unrelated topics) behavior, preventing research pollution, (3) Silent .temp folder creation with graceful failure handling - persists after research completes but before TLDR presentation, displays warning AFTER Next Steps only if write fails, (4) Cache promotion in /plan Step 2c - checks .temp/research-cache.yaml first, promotes to sessions/{folder}/research.yaml with id update, deletes temp cache after use, falls back to conversation materialization if no cache. UX preserved: TLDR and Next Steps remain final visible output, permission prompt (if triggered) appears before TLDR. Addresses critical workflow gap for multi-research sessions requiring /clear before /plan."

  - version: "3.1"
    date: "2025-12-12"
    changes: "Simplified topic detection from algorithmic to agentic approach. Replaced verbose 25-line keyword extraction, frequency counting, and 30% threshold calculation instructions with concise 3-line semantic comparison instruction that trusts agent reasoning. Added topic relevance check during cache promotion in /plan Step 2c - cache is only promoted if related to current planning context, otherwise skipped with fallback to conversation materialization. This prevents unrelated research contamination (e.g., authentication cache polluting CSS refactor session). Changes embody philosophical shift: treat LLMs as reasoning engines, not rule executors. Maintains silent execution principle - agents compare and decide without showing work. Template-only changes in research.md and plan.md."

related_specs:
  - research-persistence-intelligent-20251027213207
  - remove-research-caching-20251103150000
  - research-persistence-cache-20251128091500
  - simplify-topic-detection-20251212000000

notes: |
  Key design principles:
  - "Research is cheap to generate but valuable when it informs a specific spec"
  - "Keep spec.yaml clean - research context belongs in separate artifact"
  - "Intelligent materialization - condense, don't copy-paste"
  - "Graceful degradation - spec can proceed without research context"
  - "Single source of truth - one research.yaml per spec"
  - "Prioritize UX over theoretical edge case coverage"

  Template-only implementation:
  - No TypeScript/JavaScript code changes
  - Modified 4 command templates + research-template.yaml
  - Updated README.md and .gitignore
  - Automatic distribution via existing release packaging script

  Architecture evolution (v2.0):
  - Removed: .research-cache.md accumulation, buildforce.json state checking, cache cleanup
  - Preserved: research.yaml materialization capability, consumption by /build and /complete
  - Trade-off: Lost interrupted session recovery, gained frictionless UX

  Future enhancements:
  - Validation for research.yaml structure (schema checking)
  - Explicit /research --materialize flag for immediate research.yaml creation
  - Document best practices for research-heavy workflows
