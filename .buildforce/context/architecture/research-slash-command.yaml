id: research-slash-command
name: "RESEARCH Slash Command"
type: structural
status: production
created: "2025-01-15"
last_updated: "2026-01-26"

summary: |
  First command in the spec-driven development workflow.
  Gathers context and prepares the context window by searching project knowledge repository,
  exploring codebase, fetching current web information, or leveraging general knowledge.

responsibilities:
  - Search .buildforce/context/_index.yaml for accumulated project knowledge
  - Determine appropriate research strategy based on query analysis
  - Produce structured reports with file paths, diagrams, and data models
  - Guide users toward next workflow step (/plan)

dependencies:
  internal:
    - context-repository: "Primary knowledge source via _index.yaml"
    - slash-commands: "Part of 5-command workflow system"
    - cli-architecture: "Command template distributed via CLI project initialization"
    - research-persistence: "Appends complete output to .research-cache.md for materialization"
  external:
    - None (instruction template for Claude Code)

files:
  primary:
    - src/templates/commands/research.md
  secondary:
    - .buildforce/context/_index.yaml (searched first)
    - .claude/commands/research.md (deployed template)

command_signature:
  syntax: "/research <query>"
  arguments:
    - name: "query"
      type: "string"
      required: true
      description: "Natural language query describing what context is needed"
  examples:
    - "/research current best practices for OAuth 2.0 grant flow with Cognito"
    - "/research how is email sending implemented in this codebase"
    - "/research what patterns do we use for error handling"

key_guidelines:
  - name: "Project Context Search"
    priority: 1
    description: "ALWAYS start by searching .buildforce/context/_index.yaml for relevant accumulated knowledge from past spec-driven sessions"

  - name: "Recency Awareness"
    priority: 2
    description: "Detect keywords like 'current', 'latest', 'recent', 'modern', 'best practices', '2024', '2025', 'up-to-date' and use web search for current information"

  - name: "Structured Output"
    priority: 3
    description: "Present findings as report with sections: Research Summary, Project Context, Codebase Findings, External Knowledge, TLDR, Next Steps"

  - name: "Relevant File Paths"
    priority: 4
    description: "Provide explicit table/list of all relevant file paths to save manual @ references in follow-up commands"

  - name: "Architecture Visualization"
    priority: 5
    description: "Include Mermaid diagrams showing architecture, flow, or relationships for codebase queries"

  - name: "Data Models"
    priority: 6
    description: "Document data structures with properties, types, and relationships—not just summaries"

  - name: "Research Persistence"
    priority: 7
    description: "After completing research, persist COMPLETE output to .research-cache.md with session metadata for intelligent materialization during /plan execution. Internal operation between content generation and summary presentation."

  - name: "TLDR Section"
    priority: 8
    description: "Condense findings into 3-7 bullet points highlighting key discoveries. Exclude code/diagrams/file paths. Include section references and focus on what user needs to know to proceed."

  - name: "Next Steps"
    priority: 9
    description: "Suggest next action after research (e.g., 'Ready to plan?')"

research_strategies:
  project_context:
    trigger: "Always first step"
    action: "Search _index.yaml → Read matching context files"
    output: "Accumulated project knowledge"

  codebase_exploration:
    trigger: "Phrases like 'we have', 'our implementation', 'in this project', 'how is X implemented here'"
    action: "Use Grep, Glob, Read to find implementations and patterns"
    output: "File paths, code snippets, architecture diagrams"

  web_search:
    trigger: "Recency indicators detected"
    action: "Fetch current information from authoritative sources"
    output: "Links, best practices, recent documentation"

  general_knowledge:
    trigger: "Conceptual questions without recency/codebase signals"
    action: "Use training data or supplement with web search if uncertain"
    output: "Explanations, patterns, theory"

output_structure:
  sections:
    - name: "Research Summary"
      content: "High-level overview of findings"

    - name: "Project Context"
      content: "Relevant accumulated knowledge from .buildforce/context"
      conditional: "If context files found"

    - name: "Codebase Findings"
      content: "File paths (table/list), code patterns, architecture diagram (Mermaid), data models"
      conditional: "If codebase exploration performed"

    - name: "External Knowledge"
      content: "Links, best practices, recent information"
      conditional: "If web search performed"

    - name: "TLDR"
      content: "3-7 concise bullet points summarizing key findings for quick user scanning. Excludes code/diagrams. Includes section references."
      conditional: "Always present (added in v1.1)"

    - name: "Next Steps"
      content: "Suggested action (e.g., /spec, further exploration)"

design_decisions:
  - decision: "Context repository as primary source"
    rationale: "Leverages accumulated project knowledge to avoid redundant codebase exploration"

  - decision: "Automatic recency detection"
    rationale: "Prevents hallucination and outdated information for current topics"

  - decision: "Explicit file path lists"
    rationale: "Saves time—users don't need to manually @ files in subsequent commands"

  - decision: "Mermaid diagrams for architecture"
    rationale: "Visual representation helps understand complex relationships quickly"

  - decision: "Concrete data model documentation"
    rationale: "Ensures /spec and /plan have precise type information, not vague summaries"

  - decision: "TLDR section for dual-audience output"
    rationale: "Balances comprehensive context for build agents with quick scannable summary for users. Positioned before 'Next Steps' at natural decision point in workflow."

evolution:
  - version: "1.0"
    date: "2025-01-15"
    changes: "Initial implementation with 7 key guidelines and project context search"

  - version: "1.1"
    date: "2025-10-24"
    changes: "Added TLDR section (guideline #8) for dual-audience output. Template increased from 28 to 29 lines. TLDR provides 3-7 bullet points with consistent formatting (## TLDR heading, - bullets) for quick user scanning while preserving comprehensive details for build agents."

  - version: "2.0"
    date: "2025-10-28"
    changes: "Added research persistence section. Command now appends COMPLETE output to .research-cache.md with session metadata (timestamp, type=research_command) for intelligent materialization by /plan command. Template increased from 29 to 65 lines. Includes cache format specification and state checking (.current-spec) to determine if cache should accumulate."

  - version: "2.1"
    date: "2025-11-03"
    changes: "Reordered workflow steps for better UX - research persistence moved to Step 7 (between Data Models and TLDR), TLDR became Step 8, Next Steps became Step 9. Removed redundant instruction 'ALWAYS add TLDR before Next Steps' as step numbering provides implicit ordering. Removed 'After presenting findings' language from Next Steps description. Template remains 68 lines. All persistence logic preserved intact - only presentation order changed. Users now see TLDR and Next Steps as final output without scrolling."

  - version: "3.0"
    date: "2025-11-28"
    changes: "Replaced .research-cache.md with single-cache YAML strategy (.buildforce/.temp/research-cache.yaml) featuring intelligent topic detection to prevent pollution. Major changes: (1) Session-aware persistence - writes to active session's research.yaml or temp cache based on buildforce.json currentSession field, (2) Topic detection algorithm with 30% keyword overlap threshold determining MERGE vs REPLACE behavior, (3) Silent .temp folder creation with graceful failure handling - warning displayed AFTER Next Steps if persistence fails, (4) Cache promotion in /buildforce.plan Step 2c with automatic deletion after use. Template expanded significantly. Preserves v2.1 UX principle: TLDR and Next Steps remain final visible output with zero file operation messages."

  - version: "3.1"
    date: "2025-12-12"
    changes: "Simplified Step 7 topic detection from verbose algorithmic instructions to concise semantic comparison. Replaced 25-line keyword extraction, frequency counting, and threshold calculation logic with 3-line instruction delegating comparison to agent's reasoning. Philosophical shift: trust LLM's native semantic understanding over prescriptive mechanical calculations. Removed mentions of keywords, tokens, percentages, thresholds. Maintains silent execution - agents compare cache and new research internally, decide MERGE or REPLACE, continue without outputting comparison process. Template reduced by 10 lines. MERGE/REPLACE behavior sections preserved intact. Complements v3.0's silent execution principle by eliminating verbose algorithm that encouraged step-by-step output."

related_specs:
  - add-research-tldr-section-20251024104500
  - research-persistence-intelligent-20251027213207
  - reorder-research-workflow-20251103143500
  - research-persistence-cache-20251128091500
  - simplify-topic-detection-20251212000000

notes: |
  Most important command in the workflow—sets foundation for /plan, /build.
  Instruction template (68 lines as of v2.1) that enhances user queries without teaching HOW to research.
  Build agents already know how to research; this command adds workflow-specific context.
  Masterpiece feature: .buildforce/context/_index.yaml as primary knowledge source.

  v1.1 enhancement: TLDR section addresses dual-audience design pattern—comprehensive details for build agents,
  scannable summary for users. Could be applied to other verbose command outputs.
  
  v2.0 enhancement: Research persistence ensures findings are preserved for /plan materialization.
  
  v2.1 enhancement: Workflow reordering (Step 7: persistence, Step 8: TLDR, Step 9: Next Steps) ensures
  user-facing summary remains visible without scrolling. Research persistence happens silently between
  content generation and summary presentation.
