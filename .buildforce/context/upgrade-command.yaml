id: upgrade-command
name: Upgrade Command
type: feature
status: production
created: 2025-10-28
last_updated: 2025-12-01

summary: |
  Slash command for upgrading existing Buildforce projects to the latest templates, scripts,
  and slash commands while preserving user-created content (context repository and specs).
  Automatically detects project configuration and supports selective override via flags.
  Supports local artifact loading via --local flag for offline workflows and testing.
  Updates .gitignore to include .buildforce/.temp entry for temporary file exclusion.

responsibilities:
  - Upgrade slash commands, templates, and scripts to latest versions from GitHub Releases or local artifacts
  - Preserve user-created content (.buildforce/context/ and .buildforce/specs/)
  - Auto-detect AI assistant and script type from buildforce.json configuration
  - Support configuration overrides via --ai and --script flags
  - Provide interactive AI assistant selection prompts matching init command experience
  - Pre-select existing AI assistants as defaults in interactive prompts
  - Support local artifact loading via --local flag for offline/testing workflows
  - Provide dry-run mode to preview changes before applying
  - Display upgrade progress with clear status indicators
  - Update buildforce.json with version metadata after successful upgrade
  - Update .gitignore to include .buildforce/.temp entry if not already present
  - Implement atomic operations with rollback on failure
  - Handle backward compatibility with projects initialized by older CLI versions

dependencies:
  internal:
    - cli-architecture: "Uses template download, extraction, and progress tracking infrastructure"
    - init-command: "Shares template distribution and file copying utilities"
    - local-artifact-resolution: "Resolves local artifacts when --local flag provided"
  external:
    - commander: "^12.0.0 - CLI argument parsing for upgrade command"
    - fs-extra: "^11.2.0 - File system operations (copy, remove, ensureDir)"
    - ora: "^8.2.0 - Progress spinners for upgrade steps"
    - chalk: "^5.4.1 - Colored terminal output for status messages"
    - inquirer: "^10.2.3 - Interactive prompts for missing configuration"
    - glob: "^10.3.10 - Pattern matching for local artifact discovery"

files:
  primary:
    - src/commands/upgrade/index.ts
    - src/commands/upgrade/validation.ts
    - src/commands/upgrade/execution.ts
  secondary:
    - src/cli.ts
    - src/utils/config.ts
    - src/types.ts

interfaces:
  exports:
    - name: "buildforce upgrade"
      signature: "CLI command with options: --ai, --script, --dry-run, --debug, --github-token, --skip-tls"
      description: "Upgrades project templates to latest version while preserving context and specs"

command_signature:
  syntax: "buildforce upgrade [options]"
  arguments:
    - name: "--ai"
      type: "string"
      required: false
      description: "Override AI assistant choice (claude, copilot, cursor, etc.)"
    - name: "--script"
      type: "string"
      required: false
      description: "Override script type choice (sh, ps)"
    - name: "--local"
      type: "string"
      required: false
      description: "Use local artifacts from directory (default: .genreleases)"
    - name: "--dry-run"
      type: "boolean"
      required: false
      description: "Preview changes without applying them"
    - name: "--debug"
      type: "boolean"
      required: false
      description: "Show detailed debug information"
    - name: "--github-token"
      type: "string"
      required: false
      description: "GitHub API token for authentication"
    - name: "--skip-tls"
      type: "boolean"
      required: false
      description: "Skip TLS verification for GitHub API"
  examples:
    - "buildforce upgrade"
    - "buildforce upgrade --dry-run"
    - "buildforce upgrade --ai claude --script sh"
    - "buildforce upgrade --local"
    - "buildforce upgrade --local=/path/to/artifacts"
    - "buildforce upgrade --github-token ghp_xxx"

design_decisions:
  - decision: "Store aiAssistant and scriptType in buildforce.json"
    rationale: "Enables upgrade command to auto-detect project configuration without re-prompting users. Single source of truth for project settings."

  - decision: "Preserve .buildforce/context/ and .buildforce/specs/ entirely"
    rationale: "User-created content must never be modified during upgrade. These directories contain accumulated project knowledge and active work that represents significant user investment."

  - decision: "Support --ai and --script override flags"
    rationale: "Allows users to switch AI assistants or script types during upgrade without manually editing buildforce.json. Provides flexibility for migration scenarios."

  - decision: "Implement atomic operations with rollback on failure"
    rationale: "Prevents partial upgrades that leave project in broken state. Use temporary directory for extraction, then atomic file operations with backup/restore capability."

  - decision: "Reuse init command infrastructure (download, extract, step tracking)"
    rationale: "Reduces code duplication and ensures consistent behavior. The core file operations are identical between init and upgrade, only the target directories differ."

  - decision: "Add --dry-run flag for preview mode"
    rationale: "Standard CLI pattern. Allows users to see what would change before committing to upgrade, reducing anxiety about overwriting files."

  - decision: "Always prompt for AI assistant selection unless --ai flag provided"
    rationale: "Matches init command behavior and provides consistent UX. Users can modify their AI assistant selection during upgrade without CLI flags or manual config editing. Pre-selecting existing configuration reduces friction while allowing easy modification."

  - decision: "Add --local flag for local artifact support"
    rationale: "Enables offline workflows, local testing, and faster iteration during development. Reuses local artifact resolution infrastructure for consistency with init command."

architecture_flow: |
  Upgrade Process:

  1. Validation Phase (validation.ts):
     - validateUpgradePrerequisites() - Check buildforce.json exists
     - Check .buildforce/ directory exists
     - Validate buildforce.json is valid JSON
     - Fail gracefully with clear error messages

  2. Configuration Detection (index.ts):
     - Read buildforce.json configuration
     - Extract aiAssistant and scriptType fields
     - If --ai flag provided: merge with existing config and skip prompt
     - Otherwise: always prompt for AI assistant selection with interactive checkbox interface
     - Pre-select existing config?.aiAssistants as defaults in prompt
     - Show context-aware messaging ("Modify your AI assistant(s) (current: claude):" vs "No AI assistant found")
     - Update buildforce.json with selections

  3. Template Download (execution.ts):
     - If --local flag provided:
       * Call resolveLocalArtifact() to find matching ZIP in local directory
       * Pass localZipPath to download function
       * Skip GitHub API entirely
     - Otherwise:
       * Reuse downloadTemplateFromGithub() from init
       * Fetch latest template ZIP from GitHub Releases
     - Extract to temporary directory
     - Validate template structure

  4. Selective File Replacement (execution.ts):
     - Create backups of existing files before replacement
     - Replace slash commands in AI assistant folder (e.g., .claude/commands/)
     - Replace templates in .buildforce/templates/
     - Replace scripts in .buildforce/scripts/
     - SKIP .buildforce/context/ (preserve user context)
     - SKIP .buildforce/specs/ (preserve user specifications)
     - Use atomic file operations (backup → replace → cleanup)

  5. Rollback Mechanism (execution.ts):
     - Monitor each operation for errors
     - If any step fails, restore from backups
     - Clean up temporary files
     - Report failure with detailed error message

  6. Finalization (execution.ts):
     - Update buildforce.json with version metadata
     - Update .gitignore to include .buildforce/.temp if not present (idempotent check)
     - Remove backups if upgrade successful
     - Clean up temporary directory
     - Display success summary

  Dry-Run Mode:
  - Log what would be updated (files, directories)
  - Show configuration that would be used
  - Exit before making any changes
  - No temporary files or backups created

implementation_phases:
  phase_1:
    name: "Extend buildforce.json Configuration"
    tasks:
      - "Extend BuildforceConfig interface with aiAssistant, scriptType, version fields"
      - "Add saveBuildforceConfig() and readBuildforceConfig() functions to utils/config.ts"
      - "Update init command to persist configuration to buildforce.json"
    validation: "Running buildforce init creates buildforce.json with aiAssistant and scriptType"

  phase_2:
    name: "Create Upgrade Command Structure"
    tasks:
      - "Create src/commands/upgrade/index.ts with main upgradeCommand() function"
      - "Create src/commands/upgrade/validation.ts with validateUpgradePrerequisites()"
      - "Add UpgradeOptions interface to src/types.ts"
      - "Register upgrade command in src/cli.ts with Commander"
    validation: "buildforce upgrade --help shows command documentation"

  phase_3:
    name: "Implement Selective File Replacement"
    tasks:
      - "Create src/commands/upgrade/execution.ts with executeUpgrade() function"
      - "Implement configuration detection with override support"
      - "Implement dry-run mode that previews changes"
      - "Add progress tracking using StepTracker"
      - "Update buildforce.json with version metadata after upgrade"
    validation: "Upgrade replaces commands, templates, scripts but preserves context and specs"

  phase_4:
    name: "Error Handling and Atomicity"
    tasks:
      - "Implement temporary directory extraction with atomic file replacement"
      - "Add rollback logic for failed upgrades"
      - "Add comprehensive error messages for common failures"
      - "Add backward compatibility for projects without aiAssistant/scriptType"
    validation: "Failed upgrades rollback successfully with clear error messages"

key_features:
  safety:
    - "Never modifies .buildforce/context/ (user-created knowledge)"
    - "Never modifies .buildforce/specs/ (user specifications)"
    - "Atomic operations with rollback on failure"
    - "Backup mechanism before replacing files"
    - "Dry-run mode to preview changes"

  convenience:
    - "Auto-detects project configuration from buildforce.json"
    - "Supports override flags for switching AI assistants or script types"
    - "Progress tracking with step-by-step status"
    - "Backward compatibility with older projects"
    - "Interactive prompts for missing configuration"

  reliability:
    - "Validation checks before making changes"
    - "Clear error messages for all failure scenarios"
    - "Network failure handling"
    - "Disk space validation"
    - "Version metadata tracking in buildforce.json"

edge_cases_handled:
  - "Project initialized before this feature (buildforce.json missing aiAssistant/scriptType) → Interactive prompts collect missing values"
  - "Corrupted buildforce.json → Clear JSON parsing error with file path"
  - "Missing AI assistant folder despite configuration → Creates folder structure during upgrade"
  - "Network failures during download → Rollback with clear error message"
  - "Disk space issues → Early validation prevents partial writes"
  - "User has modified template files → Backup mechanism preserves originals, allows manual diff/restore"

evolution:
  - version: "1.0"
    date: "2025-10-28"
    changes: "Initial implementation with auto-detection, dry-run mode, atomic operations, and backward compatibility"

  - version: "1.1"
    date: "2025-10-28"
    changes: "Added --local flag for local artifact support, enabling offline workflows and faster local testing iterations"

  - version: "1.2"
    date: "2025-11-25"
    changes: "Added interactive AI assistant selection prompts matching init command behavior. Upgrade now always prompts for AI selection (unless --ai flag provided), pre-selecting existing configuration as defaults. Updated README documentation with upgrade command section explaining interactive behavior and all CLI options."

  - version: "1.3"
    date: "2025-12-01"
    changes: "Added .gitignore update logic to ensure .buildforce/.temp entry is present during upgrade. Follows init's pattern with idempotent check to prevent duplication. Includes debug logging for transparency. Placed after config update step to maintain logical cohesion."

related_specs:
  - add-upgrade-command-20251027000000
  - add-local-flag-init-upgrade-20251028143052
  - upgrade-ai-prompt-20251125143052
  - add-temp-folder-gitignore-upgrade-20251201000000

notes: |
  The upgrade command is a critical feature for maintaining Buildforce projects over time.
  It enables users to benefit from:
  - New slash command features and improvements
  - Bug fixes in templates and scripts
  - Enhanced workflow capabilities
  - Security updates

  Without the upgrade command, users would need to manually copy files or re-initialize
  their projects, risking loss of accumulated context and specifications.

  Key design trade-offs:
  - Simplicity over flexibility: No version-specific migrations, just upgrade to latest
  - Safety over convenience: Always preserve user content, even if it means manual merges
  - Transparency over automation: Show what will change (dry-run) before making changes

  Future enhancements:
  - Add --backup flag to create timestamped backup before upgrade
  - Add version checking to warn users if newer CLI version available
  - Implement migration scripts for handling breaking changes between major versions
  - Support selective upgrades (--only-commands, --only-templates, --only-scripts)
  - Create upgrade diff report showing exactly what changed
