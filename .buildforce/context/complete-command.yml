id: complete-command
name: "Complete Command Template"
type: feature
status: production
created: 2025-01-23
last_updated: 2025-01-23

summary: |
  Template-only slash command that guides AI agents through finalizing specs by creating
  or updating context files. Completely agent-driven with no script dependencies. Uses
  _schema.yml template for structure and performs intelligent merging of existing files.

responsibilities:
  - Verify active spec exists via .current-spec state file
  - Load spec.yaml and plan.yaml artifacts for analysis
  - Proactively search _index.yml to determine context file updates vs creation
  - Generate semantic filenames for new context files (kebab-case, no prefixes)
  - Create new context files using _schema.yml template structure
  - Intelligently merge updates into existing context files (preserve history)
  - Update _index.yml with new entries including description field
  - Validate all spec requirements were met
  - Clear .current-spec state to mark spec as complete
  - Present concise completion summary to user

dependencies:
  internal:
    - .current-spec: "State file tracking active spec folder name"
    - context/_index.yml: "Index of all context files for discovery"
    - context/_schema.yml: "Template structure for new context files"
    - spec.yaml: "Specification file containing requirements"
    - plan.yaml: "Implementation plan with design decisions"
  external:
    - None (template-only command, no script execution)

files:
  primary:
    - src/templates/commands/complete.md
  secondary:
    - .buildforce/context/_schema.yml
    - .buildforce/context/_index.yml

command_signature:
  syntax: "/complete [notes]"
  arguments:
    - name: "notes"
      type: "string"
      required: false
      description: "Optional completion notes or confirmations"
  examples:
    - "/complete"
    - "/complete All tests passing, ready to finalize"

design_decisions:
  - decision: "Eliminate script dependency entirely"
    rationale: "Previous complete-spec scripts auto-generated context files with spec ID as filename and hardcoded content, contradicting semantic naming philosophy. Scripts also overwrote files instead of intelligent merges. Template-only approach gives agents full autonomy."

  - decision: "Agent-driven semantic naming"
    rationale: "Context files represent system components, not spec intent. Agent analyzes conversation/spec/plan to identify component names (e.g., 'authentication', 'build-command') rather than deriving from spec ID."

  - decision: "Intelligent merging over overwriting"
    rationale: "Preserves context history and prevents data loss. Agents append to evolution section, update file lists, add to related_specs array rather than replacing entire files."

  - decision: "Use _schema.yml as template"
    rationale: "Provides consistent structure across all context files. Agents load schema, understand fields, and populate with actual project information rather than placeholder text."

  - decision: "Add description field to index entries"
    rationale: "Short one-liner descriptions (max 100 chars) improve searchability without opening files. Users can quickly scan _index.yml to find relevant contexts."

  - decision: "Proactive _index.yml search"
    rationale: "Agent reads existing index to determine update vs create decision. Prevents duplicate context files for same component."

evolution:
  - version: "1.0"
    date: "2025-01-07"
    changes: "Initial template with _index.yml reading and context naming instructions"

  - version: "2.0"
    date: "2025-01-23"
    changes: "Complete rewrite as template-only command, eliminated script dependency, added 9-step workflow with schema usage and intelligent merging, added description field to index entries"

related_specs:
  - 20250107120000-redesign-spec-context

notes: |
  The /complete command follows a 9-step workflow:
  1. Verify active spec (read .current-spec or error)
  2. Load spec artifacts (spec.yaml and plan.yaml)
  3. Analyze context requirements (read _index.yml, identify components)
  4. Generate context filenames (semantic, kebab-case, max 50 chars)
  5. Create/update context files (use _schema.yml, intelligent merge)
  6. Update context index (_index.yml with new entries + description)
  7. Validate implementation (cross-check spec requirements)
  8. Clear spec state (delete .current-spec)
  9. Present completion summary (files created/updated, achievements)

  Context filename rules:
  - Use component/feature/module identity, NOT spec intent
  - Format: kebab-case, max 50 characters
  - No numeric or timestamp prefixes
  - Lowercase alphanumeric and hyphens only
  - Check _index.yml for ID conflicts before creating

  Index entry structure:
  - id: semantic-id (matches filename without .yml)
  - file: filename.yml
  - type: module/feature/component/pattern
  - description: short one-liner (max 100 chars)
  - tags: [auto-generated-tags]

  Key principles:
  - Update existing files rather than creating duplicates
  - One spec may touch multiple contexts
  - One context may be updated by many specs over time
  - Preserve existing values (id, created date, version history)
  - Never leave placeholder text - fill in real content

  File size threshold: When existing context file exceeds 500 lines,
  agent should suggest decomposition into smaller focused files
  (advisory only, not automatic).

  The command emphasizes comprehensive documentation that captures all
  design decisions and rationale from the conversation, not just spec
  artifacts. Agents should review conversation history to extract
  implementation changes, deviations, and important context.
