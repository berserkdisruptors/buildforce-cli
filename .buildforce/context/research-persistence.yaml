id: research-persistence
name: Research Persistence with Intelligent Materialization
type: feature
status: production
created: 2025-10-28
last_updated: 2025-10-29

summary: |
  Three-stage research persistence pipeline that accumulates /research output in temporary cache,
  intelligently materializes it into structured research.yaml artifacts, and enables consumption
  by /spec, /build, and /complete commands for context-aware operation.

responsibilities:
  - Accumulate /research output in .research-cache.md with session metadata
  - Materialize cache into structured research.yaml preserving diagrams, models, code snippets
  - Support intelligent merging when additional research occurs after spec creation
  - Enable /spec, /build, /complete commands to consume research context
  - Clean up temporary cache on spec completion
  - Maintain flexible YAML structure adapting to research content type

dependencies:
  internal:
    - research-slash-command: "Appends complete output to research cache"
    - spec-command: "Materializes cache to research.yaml, reads it for context-aware spec population"
    - build-command: "Loads research.yaml for implementation context"
    - complete-command: "Reads research.yaml for context enrichment, cleans up cache"
    - state-tracking: "Checks buildforce.json currentSpec to control cache accumulation"
    - cli-architecture: "Template distribution via GitHub Release packaging"
  external: []

files:
  primary:
    - src/templates/research-template.yaml
    - src/templates/commands/research.md
    - src/templates/commands/spec.md
  secondary:
    - src/templates/commands/build.md
    - src/templates/commands/complete.md
    - .gitignore

design_decisions:
  - decision: "Three-stage pipeline (accumulation → materialization → cleanup)"
    rationale: "Separates concerns: cache accumulates raw research, materialization condenses intelligently, cleanup prevents orphaned files. Clear lifecycle from ephemeral to permanent."

  - decision: "Markdown for cache, YAML for materialized research"
    rationale: "Markdown is append-friendly and preserves diagrams/code naturally. YAML maintains consistency with spec artifacts (spec.yaml, plan.yaml) while supporting flexible structure."

  - decision: "Intelligent materialization preserving diagrams, models, snippets"
    rationale: "Balances condensation with information richness. Mermaid diagrams, data models, code snippets are essential for /build context - preserve verbatim. Condense prose, merge TLDR bullets."

  - decision: "Cache only accumulates pre-spec (based on buildforce.json currentSpec state)"
    rationale: "Enforces 1:1 research-spec relationship. When spec is active, research should merge with existing research.yaml in UPDATE mode rather than accumulate in cache."

  - decision: "Gitignore cache, commit research.yaml"
    rationale: "Cache is temporary working file (like build artifacts). research.yaml is permanent spec artifact versioned alongside spec.yaml and plan.yaml."

  - decision: "Flexible template structure with optional sections"
    rationale: "Not all research produces diagrams/models/code. Template adapts to content type - omit empty sections. Prevents rigid enforcement that loses information."

  - decision: "Automatic distribution via existing release packaging"
    rationale: "No code changes needed. create-release-packages.sh (lines 115-127) already copies all files from src/templates/ to .buildforce/templates/. research-template.yaml distributed automatically."

architecture_patterns:
  accumulation_stage: |
    /research command workflow:
    1. Check .current-spec state:
       - If exists: SKIP cache (UPDATE mode will merge)
       - If empty: PROCEED with accumulation
    2. Append COMPLETE output to .research-cache.md:
       - Session separator (=== lines)
       - Timestamp (YYYY-MM-DD HH:MM:SS)
       - Type (research_command)
       - Full content (all sections, diagrams, models, code)
    3. User sees only research output + next steps

  materialization_stage: |
    /spec CREATE mode workflow:
    1. Check if .research-cache.md exists:
       - If not exists: Log info, proceed without research
       - If exists: Read and parse all sessions
    2. Read .buildforce/templates/research-template.yaml for structure
    3. Intelligent materialization:
       - PRESERVE VERBATIM: Mermaid diagrams, data models, code snippets
       - PRESERVE WITH CONTEXT: File paths (with relevance), architectural decisions (with rationale)
       - CONDENSE: Research summary prose, project context
       - MERGE: TLDR bullets from all sessions
    4. Write specs/{folder}/research.yaml with flexible structure
    5. Read research.yaml to inform spec.yaml population:
       - Extract requirements from key_findings
       - Populate open_questions with research ambiguities
       - Reference architectural_decisions in design principles

    /spec UPDATE mode workflow:
    1. Load existing research.yaml
    2. Check if new cache exists (.research-cache.md):
       - If not exists: No new research
       - If exists: Parse new sessions
    3. Intelligent merge:
       - Append new findings with update separator
       - Preserve new diagrams/models/snippets
       - Merge TLDR without duplication
       - Compare content to avoid duplicates

  consumption_stage: |
    /spec command:
    - CREATE: Reads research.yaml after materialization to inform requirement identification
    - UPDATE: Reads existing research.yaml to maintain context consistency

    /build command:
    - Loads research.yaml alongside spec.yaml and plan.yaml
    - Accesses: file_paths, mermaid_diagrams, data_models, code_snippets, architectural_decisions, TLDR

    /complete command:
    - Reads research.yaml to enrich context file documentation
    - Extracts: file_paths, architectural_decisions, key_findings

  cleanup_stage: |
    /complete command workflow:
    1. After context files created and index updated
    2. Check if .research-cache.md exists
    3. If exists: Delete using Bash tool
    4. research.yaml preserved in specs/{folder}/ as permanent artifact

cache_format: |
  ================================================================================
  Research Session: 2025-10-28 14:35:22
  Type: research_command
  ================================================================================

  ## Research Summary
  [Full research output from agent]

  ## Project Context
  [Context findings]

  ## Codebase Findings
  [File paths, code analysis]

  ## External Knowledge
  [Web search results, best practices]

  ## TLDR
  - Key finding 1
  - Key finding 2

  ================================================================================

materialized_format: |
  Flexible YAML structure with optional sections:

  id: "{spec-id}-research"
  created: "YYYY-MM-DD"
  last_updated: "YYYY-MM-DD"

  summary: |
    Condensed 2-4 sentence overview

  key_findings:
    - "Discovery with context"

  file_paths:  # OPTIONAL
    primary:
      - path: "src/file.ts"
        relevance: "Why this matters"

  mermaid_diagrams:  # OPTIONAL - preserved verbatim
    - title: "Architecture Flow"
      diagram: |
        ```mermaid
        graph TD
        ```

  data_models:  # OPTIONAL - preserved with structure
    - name: "ModelName"
      properties:
        - name: "prop"
          type: "string"

  code_snippets:  # OPTIONAL - preserved complete
    - title: "Example Pattern"
      code: |
        // Complete code

  architectural_decisions:  # OPTIONAL
    - pattern: "Pattern Name"
      rationale: "Why chosen"

  tldr:  # REQUIRED - merged from all sessions
    - "Critical point 1"

evolution:
  - version: "1.0"
    date: "2025-10-28"
    changes: "Initial implementation of research persistence with three-stage pipeline (accumulation, materialization, cleanup). Added cache format with session metadata, flexible research.yaml template, and consumption logic in /spec, /build, /complete commands."

related_specs:
  - research-persistence-intelligent-20251027213207

notes: |
  Key design principles:
  - "Research is cheap to generate but valuable when it informs a specific spec"
  - "Keep spec.yaml clean - research context belongs in separate artifact"
  - "Intelligent materialization - condense, don't copy-paste"
  - "Graceful degradation - spec can proceed without research context"
  - "Single source of truth - one research.yaml per spec"

  Template-only implementation:
  - No TypeScript/JavaScript code changes
  - Modified 4 command templates + created research-template.yaml
  - Updated .gitignore to exclude cache
  - Automatic distribution via existing release packaging script

  Edge cases handled:
  - Missing cache: Info message, proceed gracefully
  - Empty cache: No materialization
  - Malformed cache: Parse what's possible
  - Cache during active spec: Skip accumulation (UPDATE mode merges)

  Future enhancements:
  - /research-note command for explicit free-form context appending
  - Validation for research.yaml structure (schema checking)
  - TTL-based cache cleanup for abandoned research sessions
