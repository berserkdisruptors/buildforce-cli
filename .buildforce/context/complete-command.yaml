id: complete-command
name: "Complete Command Template"
type: feature
status: production
created: 2025-01-23
last_updated: 2025-10-29

summary: |
  Template-only slash command that guides AI agents through finalizing specs by creating
  or updating context files. Completely agent-driven with no script dependencies. Uses
  _schema.yaml template for structure and performs intelligent merging of existing files.

responsibilities:
  - Verify active spec exists via buildforce.json currentSpec field
  - Load spec.yaml and plan.yaml artifacts for analysis
  - Proactively search _index.yaml to determine context file updates vs creation
  - Generate semantic filenames for new context files (kebab-case, no prefixes)
  - Create new context files using _schema.yaml template structure
  - Intelligently merge updates into existing context files (preserve history)
  - Update _index.yaml with new entries including description field
  - Validate all spec requirements were met
  - Clear currentSpec in buildforce.json to mark spec as complete
  - Present concise completion summary to user

dependencies:
  internal:
    - state-tracking: "Reads buildforce.json currentSpec field to verify active spec, clears it on completion"
    - context/_index.yaml: "Index of all context files for discovery"
    - context/_schema.yaml: "Template structure for new context files"
    - spec.yaml: "Specification file containing requirements"
    - plan.yaml: "Implementation plan with design decisions"
    - research-persistence: "Reads research.yaml for context enrichment, cleans up .research-cache.md"
  external:
    - None (template-only command, no script execution)

files:
  primary:
    - src/templates/commands/complete.md
  secondary:
    - .buildforce/context/_schema.yaml
    - .buildforce/context/_index.yaml

command_signature:
  syntax: "/complete [notes]"
  arguments:
    - name: "notes"
      type: "string"
      required: false
      description: "Optional completion notes or confirmations"
  examples:
    - "/complete"
    - "/complete All tests passing, ready to finalize"

design_decisions:
  - decision: "Eliminate script dependency entirely"
    rationale: "Previous complete-spec scripts auto-generated context files with spec ID as filename and hardcoded content, contradicting semantic naming philosophy. Scripts also overwrote files instead of intelligent merges. Template-only approach gives agents full autonomy."

  - decision: "Agent-driven semantic naming"
    rationale: "Context files represent system components, not spec intent. Agent analyzes conversation/spec/plan to identify component names (e.g., 'authentication', 'build-command') rather than deriving from spec ID."

  - decision: "Intelligent merging over overwriting"
    rationale: "Preserves context history and prevents data loss. Agents append to evolution section, update file lists, add to related_specs array rather than replacing entire files."

  - decision: "Use _schema.yaml as template"
    rationale: "Provides consistent structure across all context files. Agents load schema, understand fields, and populate with actual project information rather than placeholder text."

  - decision: "Add description field to index entries"
    rationale: "Short one-liner descriptions (max 100 chars) improve searchability without opening files. Users can quickly scan _index.yaml to find relevant contexts."

  - decision: "Proactive _index.yaml search"
    rationale: "Agent reads existing index to determine update vs create decision. Prevents duplicate context files for same component."

evolution:
  - version: "1.0"
    date: "2025-01-07"
    changes: "Initial template with _index.yaml reading and context naming instructions"

  - version: "2.0"
    date: "2025-01-23"
    changes: "Complete rewrite as template-only command, eliminated script dependency, added 9-step workflow with schema usage and intelligent merging, added description field to index entries"

  - version: "3.0"
    date: "2025-10-28"
    changes: "Added research persistence integration. Updated Step 2 (Load Spec Artifacts) to read research.yaml for context enrichment. Added Step 8 (Clean Research Cache) to delete .research-cache.md after context files created. Template increased from 185 to 198 lines. research.yaml provides file paths, architectural decisions, key findings for richer context documentation."

  - version: "4.0"
    date: "2025-10-29"
    changes: "Migrated state tracking from .current-spec to buildforce.json. Updated Step 1 (Verify Active Spec) to read currentSpec field from buildforce.json. Updated Step 8 (Clear Spec State) sets currentSpec in buildforce.json to null. Examples updated to reference buildforce.json throughout."

related_specs:
  - redesign-spec-context-20250107120000
  - research-persistence-intelligent-20251027213207
  - migrate-currentspec-to-json-20251029000000

notes: |
  The /complete command follows a 9-step workflow:
  1. Verify active spec (read buildforce.json currentSpec or error)
  2. Load spec artifacts (spec.yaml and plan.yaml)
  3. Analyze context requirements (read _index.yaml, identify components)
  4. Generate context filenames (semantic, kebab-case, max 50 chars)
  5. Create/update context files (use _schema.yaml, intelligent merge)
  6. Update context index (_index.yaml with new entries + description)
  7. Validate implementation (cross-check spec requirements)
  8. Clear spec state (set currentSpec in buildforce.json to null)
  9. Present completion summary (files created/updated, achievements)

  Context filename rules:
  - Use component/feature/module identity, NOT spec intent
  - Format: kebab-case, max 50 characters
  - No numeric or timestamp prefixes
  - Lowercase alphanumeric and hyphens only
  - Check _index.yaml for ID conflicts before creating

  Index entry structure:
  - id: semantic-id (matches filename without .yaml)
  - file: filename.yaml
  - type: module/feature/component/pattern
  - description: short one-liner (max 100 chars)
  - tags: [auto-generated-tags]

  Key principles:
  - Update existing files rather than creating duplicates
  - One spec may touch multiple contexts
  - One context may be updated by many specs over time
  - Preserve existing values (id, created date, version history)
  - Never leave placeholder text - fill in real content

  File size threshold: When existing context file exceeds 500 lines,
  agent should suggest decomposition into smaller focused files
  (advisory only, not automatic).

  The command emphasizes comprehensive documentation that captures all
  design decisions and rationale from the conversation, not just spec
  artifacts. Agents should review conversation history to extract
  implementation changes, deviations, and important context.
