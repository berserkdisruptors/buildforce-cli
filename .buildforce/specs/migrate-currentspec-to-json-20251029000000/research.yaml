id: "migrate-currentspec-to-json-20251029000000-research"
created: "2025-10-29"
last_updated: "2025-10-29"

summary: |
  Research on .current-spec state tracking mechanism in BuildForce CLI. The file serves as single source
  of truth for active spec sessions, controlling CREATE/UPDATE mode decisions and research cache behavior
  across /spec, /research, and /complete commands. Replaced legacy pattern files in v2.0 for simplicity.

key_findings:
  - ".current-spec is a plain text file at .buildforce/.current-spec containing active spec folder name"
  - "File lifecycle: created by create-spec-files.sh during /spec CREATE, deleted by /complete on finalization"
  - "Controls research cache accumulation: cache only appends when no active spec exists"
  - "Used by all slash commands (spec.md, research.md, complete.md) for state determination"
  - "Gitignored to prevent merge conflicts - session state is local to developer"
  - "Functions get_current_spec() and set_current_spec() defined in src/scripts/bash/common.sh:33-45"

file_paths:
  primary:
    - path: "src/scripts/bash/common.sh"
      relevance: "Lines 33-45 define get_current_spec() and set_current_spec() functions for reading/writing state file"
    - path: "src/scripts/bash/create-spec-files.sh"
      relevance: "Line 99 calls set_current_spec() after creating new spec folder to track active session"
    - path: "src/templates/commands/spec.md"
      relevance: "Lines 23-25 read .current-spec to determine CREATE vs UPDATE mode"
    - path: "src/templates/commands/complete.md"
      relevance: "Lines 19-20 read .current-spec to verify active spec, lines 124-129 delete it on completion"
    - path: "src/templates/commands/research.md"
      relevance: "Lines 37-39 check .current-spec to determine research cache accumulation behavior"

  secondary:
    - path: ".gitignore"
      relevance: "Line 21 excludes .current-spec from version control"
    - path: ".buildforce/context/spec-command.yaml"
      relevance: "Documents v2.0 design decision to use .current-spec for CREATE/UPDATE determination"
    - path: ".buildforce/context/research-persistence.yaml"
      relevance: "Documents cache accumulation behavior based on .current-spec state"
    - path: ".buildforce/context/complete-command.yaml"
      relevance: "Documents state verification and cleanup workflow"

mermaid_diagrams:
  - title: "Current-Spec State Flow"
    description: "How .current-spec file is used across slash commands for state tracking"
    diagram: |
      ```mermaid
      graph TD
          A[/spec command] -->|CREATE mode| B[create-spec-files.sh]
          B -->|set_current_spec| C[.buildforce/.current-spec]
          C -->|contains| D[folder-name]

          E[/spec command] -->|UPDATE mode| F{Read .current-spec}
          F -->|file exists| G[Load existing spec.yaml/plan.yaml]
          F -->|file empty/missing| H[CREATE mode]

          I[/research command] -->|check| C
          C -->|exists| J[SKIP cache accumulation]
          C -->|doesn't exist| K[Append to .research-cache.md]

          L[/complete command] -->|verify| C
          C -->|exists| M[Load spec artifacts]
          M --> N[Create/update context files]
          N -->|delete| C
          C -->|doesn't exist| O[ERROR: No active spec]

          style C fill:#ffeb3b,stroke:#f57c00,stroke-width:3px
          style D fill:#e3f2fd,stroke:#1976d2
      ```

  - title: "State Lifecycle"
    description: "Lifecycle of .current-spec file from creation to deletion"
    diagram: |
      ```mermaid
      stateDiagram-v2
          [*] --> NoActiveSpec: Initial state
          NoActiveSpec --> ActiveSpec: /spec (CREATE mode)<br/>set_current_spec()
          ActiveSpec --> ActiveSpec: /spec (UPDATE mode)<br/>read .current-spec
          ActiveSpec --> NoActiveSpec: /complete<br/>delete .current-spec

          note right of ActiveSpec
              .current-spec contains<br/>
              folder name:<br/>
              "add-auth-jwt-20250122143052"
          end note

          note right of NoActiveSpec
              .current-spec<br/>
              doesn't exist or empty
          end note
      ```

data_models:
  - name: ".current-spec File"
    description: "Plain text state file tracking active spec session"
    properties:
      - name: "location"
        type: "string"
        required: true
        description: ".buildforce/.current-spec (relative to buildforce root)"

      - name: "content"
        type: "string"
        required: true
        description: "Single line containing spec folder name (e.g., 'add-auth-jwt-20250122143052')"

      - name: "format"
        type: "string"
        required: true
        description: "{semantic-slug}-{timestamp} matching folder naming convention"

      - name: "lifecycle"
        type: "string"
        required: true
        description: "Created on spec creation, deleted on spec completion"

      - name: "version_control"
        type: "boolean"
        required: false
        description: "Gitignored - not tracked in version control"

code_snippets:
  - title: "get_current_spec Function"
    language: "bash"
    description: "Reads active spec folder name from .current-spec file"
    code: |
      # Get current spec from state file
      get_current_spec() {
          local state_file="$1/.buildforce/.current-spec"
          if [[ -f "$state_file" ]]; then
              cat "$state_file"
          fi
      }

  - title: "set_current_spec Function"
    language: "bash"
    description: "Writes spec folder name to .current-spec file to track active session"
    code: |
      # Set current spec in state file
      set_current_spec() {
          local state_file="$1/.buildforce/.current-spec"
          echo "$2" > "$state_file"
      }

architectural_decisions:
  - pattern: "Simple text file over database/JSON"
    description: ".current-spec is a plain text file containing single line (folder name)"
    rationale: "Minimal overhead, easy to debug, grep-friendly, atomic writes with simple echo command"

  - pattern: "Gitignored session state"
    description: "State file excluded from version control"
    rationale: "Prevents merge conflicts, session state is local to developer, no coordination needed"

  - pattern: "Single source of truth"
    description: "All commands rely on this one file for state determination"
    rationale: "No redundant state tracking, eliminates sync issues, simpler than external pattern files"

  - pattern: "No validation in common.sh"
    description: "common.sh functions just read/write, no format validation"
    rationale: "Commands validate format when needed, common.sh stays simple and reusable"

tldr:
  - ".buildforce/.current-spec is plain text state file containing active spec's folder name"
  - "Purpose: single source of truth for CREATE vs UPDATE mode across /spec, /research, /complete"
  - "Lifecycle: created by create-spec-files.sh, deleted by /complete command"
  - "Key functions: get_current_spec() reads, set_current_spec() writes (common.sh:33-45)"
  - "Gitignored to prevent merge conflicts - local session state only"
  - "Controls research cache accumulation (cache only accumulates when no active spec)"
  - "Design rationale: simpler than database/JSON, atomic updates, grep-friendly"
