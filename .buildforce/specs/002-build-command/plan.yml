id: 002-build-command-plan
name: "Implementation Plan for /build Command Iteration"
spec_id: "002-build-command"
type: implementation-plan
status: ready
created: "2025-10-08"
last_updated: "2025-10-08"

# ARCHITECTURE OVERVIEW

approach: |
  Apply the proven RESEARCH iteration pattern to BUILD command with script-based discovery:
  1. Add script execution step (`.buildforce/scripts/bash/check-prerequisites.sh --json`)
  2. Parse FEATURE_DIR from JSON response
  3. Analyze current 116-line structure
  4. Extract essential workflow enhancements (not HOW-TO instructions)
  5. Consolidate into ~8 numbered guidelines
  6. Integrate behavior rules inline
  7. Add bold emphasis (ALWAYS/NEVER) for critical instructions
  8. Target: 40-50 lines total (increased for script execution)

reference_models:
  - "RESEARCH command (28 lines, 7 guidelines)"
  - "implement.md command (script-based directory discovery pattern)"

# DESIGN DECISIONS

decisions:
  - decision: "Use 7 numbered guidelines instead of 10 execution steps + 11 behavior rules"
    rationale: "RESEARCH proved concise guidelines work better than verbose steps. 7 guidelines cover all critical features while staying compact. Removed error handling (agents handle this naturally) and changed confirmation to testing guidance."

  - decision: "Integrate behavior rules inline with guidelines"
    rationale: "Separate behavior rules section duplicates content. Inline integration reduces redundancy and improves clarity."

  - decision: "Remove code block examples"
    rationale: "AI agents understand deviation log format, checklist format, etc. without examples. Examples add verbosity without value."

  - decision: "Target 40-50 lines (vs. RESEARCH's 28)"
    rationale: "BUILD is more complex than RESEARCH (script execution, tracking, logging, validation, iteration). Slightly longer is acceptable while maintaining compactness."

  - decision: "Script-based FEATURE_DIR discovery"
    rationale: "Following implement.md pattern: execute `.buildforce/scripts/bash/check-prerequisites.sh --json`, parse FEATURE_DIR, load spec.yml and plan.yml. Provides reliable absolute paths."

  - decision: "Bold emphasis on ALWAYS/NEVER instructions"
    rationale: "Matches RESEARCH pattern. Draws agent attention to non-negotiable requirements (prerequisite checks, stop on errors, never auto-complete)."

  - decision: "Script execution + Context loading as guideline #1"
    rationale: "Must execute script (which verifies files exist), discover FEATURE_DIR, and load spec.yml/plan.yml before any work. Critical first step prevents wasted execution."

  - decision: "Testing guidance instead of user confirmation"
    rationale: "Agents should verify code quality and provide testing guidance (like submitting a PR) rather than asking for confirmation. User tests the code themselves after agent ensures it's ready."

  - decision: "Removed error handling guideline"
    rationale: "Build agents are excellent at handling errors in micro-iterations. This is their responsibility—no need to explicitly instruct them."

# IMPLEMENTATION STEPS

step_1:
  task: "Map current content to target guidelines"
  details: |
    Analyze current build.md structure and map to 7 target guidelines:

    Guideline 1: Script Execution & Context Loading
      - From: implement.md pattern + Current "Prerequisites" section + Step 1 + Behavior rule "NEVER proceed without spec/plan"
      - Content: Execute `.buildforce/scripts/bash/check-prerequisites.sh --json` (script verifies files exist), parse FEATURE_DIR, load {FEATURE_DIR}/spec.yml and {FEATURE_DIR}/plan.yml into context

    Guideline 2: Progress Tracking
      - From: Step 3 (Initialize Progress Tracking) + Behavior rule "ALWAYS track progress visibly"
      - Content: Display checklist based on plan steps, track iteration number

    Guideline 3: Follow the Plan
      - From: Step 4 (Execute Implementation) + Step 2 (Analyze Build Context) + Behavior rule "NEVER skip steps"
      - Content: Execute sequentially, parse $ARGUMENTS, reference file paths

    Guideline 4: Deviation Logging
      - From: Step 5 (Track Deviations) + Behavior rule "NEVER hide deviations"
      - Content: Log Original → Actual → Reason format, maintain running log

    Guideline 5: Validate Against Spec & Plan
      - From: Step 7 (Validate Against Spec) + Behavior rule "ALWAYS validate"
      - Content: Cross-check spec requirements AND plan adherence, verify edge cases, ensure code compiles

    Guideline 6: Code Quality & Testing Guidance
      - From: Step 8 (Present Results) + implement.md validation pattern
      - Content: Verify no compilation errors, run automated tests if exist, provide testing guidance (what to test, how to test, test results)

    Guideline 7: Iterative Refinement
      - From: Step 10 (Iterate if Needed) + Step 2 (Analyze Build Context)
      - Content: Support multiple /build calls, track deviations across iterations

  output: "Mapping document showing current → target guideline transformation (7 guidelines, removed error handling)"

step_2:
  task: "Write compact header (lines 1-8)"
  details: |
    Structure:
    ---
    description: Execute the implementation following the spec and plan, with progress tracking, deviation logging, and iterative refinement.
    ---

    User input:

    $ARGUMENTS

    **Context**: The user is invoking `/build` to execute implementation. $ARGUMENTS contains iteration-specific instructions or feedback.

    **Your task**: Implement the feature by following the spec and plan, tracking progress, logging deviations, and requesting confirmation.

  output: "~8 line header matching RESEARCH format"

step_3:
  task: "Write guideline 1: Script Execution & Context Loading"
  details: |
    **Key guidelines**:

    1. **Script Execution & Context Loading**: Run `.buildforce/scripts/bash/check-prerequisites.sh --json` from repo root (script verifies files exist and will fail if missing). Parse the JSON response to extract **FEATURE_DIR** (absolute path). Load {FEATURE_DIR}/spec.yml and {FEATURE_DIR}/plan.yml into context. **NEVER proceed** without both files loaded.

  output: "3-4 lines with script execution, JSON parsing, file loading, and NEVER emphasis"

step_4:
  task: "Write guideline 2: Progress Tracking"
  details: |
    2. **Progress Tracking**: Display a visible checklist of implementation steps from the plan at the start. Mark steps as in-progress/complete as you work. Track which iteration this is (1st `/build`, 2nd `/build`, etc.) for context.

  output: "2-3 lines focused on visible tracking"

step_5:
  task: "Write guideline 3: Follow the Plan"
  details: |
    3. **Follow the Plan**: Execute implementation steps sequentially as specified in the plan. Parse $ARGUMENTS for iteration-specific instructions (e.g., "change library X to Y", "fix edge case Z"). Reference specific file paths when creating or modifying code. Keep progress updates concise but informative.

  output: "3-4 lines covering sequential execution and $ARGUMENTS parsing"

step_6:
  task: "Write guideline 4: Deviation Logging"
  details: |
    4. **Deviation Logging**: If you deviate from the original plan (due to user instructions, discovered issues, or better approaches), log each deviation: **Original** � **Actual** � **Reason**. Maintain a running deviation log throughout the build and across iterations. NEVER hide deviationstransparency is critical.

  output: "3-4 lines with format and NEVER emphasis"

step_7:
  task: "Write guideline 5: Validate Against Spec & Plan"
  details: |
    5. **Validate Against Spec & Plan**: After completing all implementation steps, cross-check the implementation against BOTH the spec's requirements AND the plan's steps. Verify all functional requirements are met, edge cases are handled, and the plan was followed (or deviations logged). Ensure code compiles with no errors.

  output: "3-4 lines emphasizing dual validation (spec + plan) and code compilation"

step_8:
  task: "Write guideline 6: Code Quality & Testing Guidance"
  details: |
    6. **Code Quality & Testing Guidance**: Before presenting work, verify: (1) code compiles with no errors, (2) run automated tests if they exist and report results, (3) check for obvious missing pieces. Then provide testing guidance: what to test (specific features/scenarios), how to test (steps to verify), and any test results from automated tests. Think of this as submitting a PR—ensure nothing obviously broken.

  output: "4-5 lines covering quality checks and testing guidance"

step_9:
  task: "Write guideline 7: Results & Confirmation"
  details: |
    7. **Results & Confirmation**: Present (1) summary of completed work with file paths, (2) deviation log (if any), (3) validation status against spec. Request explicit confirmation: "Does this implementation match your expectations?" Suggest `/complete` if satisfied, or `/build [instructions]` again for changes. NEVER auto-mark the feature as completethat's `/complete`'s job.

  output: "4-5 lines covering results presentation and confirmation request"

step_10:
  task: "Write footer (lines 43-45)"
  details: |
    Context: {$ARGUMENTS}

  output: "2-3 lines with context placeholder"

step_11:
  task: "Review and validate"
  details: |
    - Count total lines (target: 35-45)
    - Verify all 8 functional requirements preserved
    - Check bold emphasis on ALWAYS/NEVER/STOP/DO NOT
    - Confirm no HOW-TO instructions (only WHAT workflow)
    - Ensure format matches RESEARCH pattern
    - Validate all critical features present

  output: "Validation checklist confirming spec requirements met"

# FILE STRUCTURE

files_to_modify:
  - path: "src/templates/commands/build.md"
    change_type: "rewrite"
    current_lines: 116
    target_lines: 35-45
    backup: false  # Git history serves as backup

# GUIDELINE STRUCTURE SUMMARY

target_structure:
  header:
    lines: "1-8"
    content: "YAML frontmatter + user input context + task description"

  guidelines:
    lines: "9-38"
    content: |
      **Key guidelines**:

      1. Script Execution & Context Loading (~3-4 lines)
      2. Progress Tracking (~2-3 lines)
      3. Follow the Plan (~3-4 lines)
      4. Deviation Logging (~3-4 lines)
      5. Validate Against Spec & Plan (~3-4 lines)
      6. Code Quality & Testing Guidance (~4-5 lines)
      7. Iterative Refinement (~2-3 lines)

  footer:
    lines: "39-41"
    content: "Context placeholder"

total_estimate: "40 lines (within 35-45 target, removed error handling guideline)"

# CONTENT MAPPING TABLE

mapping:
  current_line_1_to_3: "Keep (YAML frontmatter)"
  current_line_4_to_15: "Compress to lines 4-8 (header context)"
  current_line_16_to_18: "Integrate into guideline 1 (prerequisites)"
  current_line_20_to_25: "Integrate into guideline 1 (load spec/plan)"
  current_line_27_to_31: "Integrate into guideline 3 + 8 (analyze context, iteration)"
  current_line_32_to_42: "Integrate into guideline 2 (progress tracking)"
  current_line_43_to_50: "Integrate into guideline 3 (follow plan)"
  current_line_51_to_63: "Integrate into guideline 4 (deviation logging)"
  current_line_65_to_73: "Integrate into guideline 5 (error handling)"
  current_line_74_to_79: "Integrate into guideline 6 (validate spec)"
  current_line_80_to_90: "Integrate into guideline 7 (present results)"
  current_line_91_to_97: "Integrate into guideline 7 (confirmation)"
  current_line_98_to_101: "Integrate into guideline 8 (iterate)"
  current_line_103_to_113: "Distribute across guidelines 1-7 (behavior rules inline)"
  current_line_115_to_116: "Keep (context footer)"

# VALIDATION CRITERIA

success_metrics:
  - "Total lines: 35-45 "
  - "Guidelines: 8 numbered "
  - "Bold emphasis: ALWAYS/NEVER/STOP/DO NOT "
  - "Prerequisites checked: Guideline 1 "
  - "Progress tracking: Guideline 2 "
  - "Deviation logging: Guideline 4 "
  - "Error handling: Guideline 5 "
  - "Validation: Guideline 6 "
  - "Confirmation: Guideline 7 "
  - "Iteration support: Guideline 8 "
  - "No HOW-TO instructions "
  - "Format matches RESEARCH "

# NOTES

reference_comparison: |
  RESEARCH command structure (28 lines):
  - Header: 8 lines
  - Guidelines: 7 numbered (14 lines)
  - Footer: 0 lines (ends with guideline 7)
  - Total: 28 lines

  BUILD command structure (target 42 lines):
  - Header: 8 lines
  - Guidelines: 8 numbered (~30 lines)
  - Footer: 2 lines
  - Total: ~42 lines

  Difference: +14 lines due to BUILD complexity (tracking, logging, validation, iteration)
  Still achieves 64% reduction from original 116 lines.

key_insight: |
  The hardest part is identifying what to REMOVE (HOW-TO instructions) vs.
  what to KEEP (WHAT workflow enhancements). This plan serves as the decision
  framework for that extraction process.

# SCRIPT EXECUTION DETAILS

script_info:
  path: ".buildforce/scripts/bash/check-prerequisites.sh"
  flags: "--json"
  expected_json_output: |
    {
      "FEATURE_DIR": "/absolute/path/to/.buildforce/specs/002-build-command"
    }
  
  usage_in_guideline_1: |
    1. Execute: `.buildforce/scripts/bash/check-prerequisites.sh --json` from repo root
    2. Script validates that spec.yml and plan.yml exist (exits with error if not)
    3. Parse JSON response to extract FEATURE_DIR value
    4. Use FEATURE_DIR to construct absolute paths:
       - {FEATURE_DIR}/spec.yml
       - {FEATURE_DIR}/plan.yml
    5. Load both files into context using Read tool

  rationale: |
    Script-based discovery eliminates hardcoded paths, handles file verification,
    and ensures agents always work with the correct feature directory.
    Matches implement.md pattern proven effective.
