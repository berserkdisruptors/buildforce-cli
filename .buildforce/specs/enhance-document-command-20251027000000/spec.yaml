id: enhance-document-command-20251027000000
name: "Enhanced /document Command with /complete UX Improvements"
type: feature
status: draft
created: "2025-10-27"
last_updated: "2025-10-27"

summary: |
  Refactor the /document command to adopt the proven UX patterns from /complete command's recent
  improvements, including enhanced context analysis workflow (steps 3-6), semantic filename
  generation with conflict resolution, conversation history analysis, proactive /research
  suggestions for empty context, and completion summaries instead of confirmation prompts.

# INTENT / PROBLEM STATEMENT

problem: |
  The /document command (29 lines, 7 guidelines) currently works well but lacks the refined
  UX improvements recently introduced in /complete v2.0 (179 lines, 9-step workflow). Key gaps:

  1. **Guidelines 1-6 don't mirror /complete steps 3-6**: The /complete workflow (Analyze Context
     Requirements → Generate Filenames → Create/Update Files → Update Index) is more robust and
     structured than /document's current guidelines.

  2. **Filename generation lacks detail**: Current guideline 3 is brief compared to /complete's
     step 4 which includes careful semantic naming, max 50 char limits, ID conflict checking,
     and alternative ID generation strategies.

  3. **No conversation analysis depth**: Without spec.yaml/plan.yaml to reference, /document needs
     to analyze conversation history more carefully to identify what should be documented, but
     current guidelines don't emphasize this like /complete step 3 does.

  4. **Missing empty context detection**: Users might run /document without any context loaded,
     expecting the agent to figure it out. Command should detect this and suggest /research first.

  5. **Confirmation prompt instead of summary**: Current guideline 7 requests user confirmation
     before writing, but /complete provides a concise completion summary after writing (better UX).

  6. **Context type detection could be clearer**: Auto-detection of module/feature/component/pattern
     works but could follow /complete's more explicit analysis approach.

motivation: |
  The /complete command recently received significant UX improvements that make it feel polished
  and professional. Users should experience the same quality when using /document. By adopting
  /complete's proven patterns (especially steps 3-6), /document will:

  - Provide more consistent UX across both context-writing commands
  - Handle edge cases better (empty context, filename conflicts, large files)
  - Give users clearer visibility into what was documented through summaries
  - Prevent wasted effort when context window is empty (suggest /research)
  - Follow the same careful filename generation and validation logic

# GOALS

primary_goals:
  - Refactor /document guidelines 1-6 to align with /complete steps 3-6 workflow and structure
  - Add empty context detection with proactive /research suggestion
  - Replace confirmation prompt (guideline 7) with completion summary (like /complete step 9)
  - Enhance filename generation with detailed validation and conflict resolution
  - Improve conversation analysis instructions to compensate for lack of spec artifacts

secondary_goals:
  - Maintain /document's compact template format (target 35-50 lines, acceptable to grow to ~60-70)
  - Preserve existing functionality (CREATE/UPDATE modes, intelligent merge, auto cross-referencing)
  - Ensure consistent terminology and approach between /complete and /document
  - Keep template-only approach (no script execution)

# REQUIREMENTS

functional_requirements:
  - FR1: Command MUST detect if conversation context is insufficient (minimal file reads, no substantive discussion) and suggest user run /research first before documenting
  - FR2: Guidelines 1-6 MUST be restructured to mirror /complete steps 3-6 pattern (Analyze Context Requirements → Generate Filenames → Create/Update Files → Update Index)
  - FR3: Guideline for analyzing context requirements MUST emphasize careful conversation history analysis since no spec.yaml/plan.yaml exists
  - FR4: Guideline for generating filenames MUST include detailed rules: kebab-case, max 50 characters, no numeric/timestamp prefixes, component identity (not spec intent), lowercase alphanumeric and hyphens only
  - FR5: Guideline for generating filenames MUST include ID conflict checking strategy: search _index.yaml proactively, choose alternative ID if conflict exists (append descriptor, use synonym)
  - FR6: Guideline for creating/updating files MUST distinguish between CREATE mode (new files with _schema.yaml) and UPDATE mode (intelligent merge with preservation)
  - FR7: Guideline for updating index MUST specify entry structure: id, file, type, description (short one-liner max 100 chars), auto-generated tags
  - FR8: Final guideline (replacing confirmation) MUST provide condensed completion summary: files created/updated, what was documented, brief achievement summary
  - FR9: Completion summary MUST NOT request user confirmation - command should execute writes and report what was done
  - FR10: Command MUST maintain existing automatic related context updates (no per-file confirmation)
  - FR11: Command MUST preserve intelligent merge strategy for UPDATE mode (preserve existing, append to lists, update changed fields)
  - FR12: Command MUST maintain file size threshold advisory (>500 lines suggest decomposition)

non_functional_requirements:
  - NFR1: Template length may grow from 29 lines to ~60-70 lines (acceptable trade-off for improved UX)
  - NFR2: Guidelines should use similar wording to /complete where workflows overlap (consistency)
  - NFR3: Template must remain easy to read and understand (clear section breaks, concise instructions)
  - NFR4: Must preserve template-only approach (no bash/powershell script execution)

# SCOPE

in_scope:
  - Rewrite guidelines 1-6 to follow /complete steps 3-6 structure and detail level
  - Add empty context detection with /research suggestion (new guideline or preamble check)
  - Replace guideline 7 confirmation prompt with completion summary
  - Enhance filename generation rules with validation and conflict resolution details
  - Improve conversation analysis instructions (compensate for no spec artifacts)
  - Add description field to index entry structure (matching /complete v2.0)
  - Update command template at src/templates/commands/document.md
  - Maintain existing behaviors: CREATE/UPDATE modes, intelligent merge, auto cross-referencing, type auto-detection

out_of_scope:
  - Changing command signature or arguments ($ARGUMENTS format)
  - Adding script execution (remains template-only)
  - Modifying context schema structure (_schema.yaml changes)
  - Changing index structure beyond adding description field
  - Integration with /research command (only suggest, don't auto-invoke)
  - Automatic context splitting when >500 lines (advisory only)
  - Batch processing multiple topics
  - User-provided type flags (auto-detect remains)

# DESIGN PRINCIPLES

design_principles:
  - "Consistency First: Mirror /complete's proven UX patterns where workflows overlap"
  - "Empty Context Guard: Detect insufficient context early, suggest /research proactively"
  - "Summary Over Confirmation: Report what was done, don't ask permission after thorough analysis"
  - "Semantic Naming: Context files reflect component identity with detailed validation rules"
  - "Conversation Analysis: Compensate for lack of spec artifacts with careful history review"
  - "Preserve Strengths: Keep existing intelligence (auto-detection, merge, cross-referencing)"

# ACCEPTANCE CRITERIA

acceptance_criteria:
  - AC1: Empty context detection implemented - when user runs /document with minimal conversation context, agent suggests running /research first
  - AC2: Guidelines restructured to match /complete steps 3-6 pattern with similar section names and structure
  - AC3: Filename generation guideline includes all validation rules: kebab-case, max 50 chars, no prefixes, component identity, alphanumeric+hyphens
  - AC4: Filename generation guideline includes ID conflict resolution: search _index.yaml first, choose alternative (append descriptor/use synonym)
  - AC5: Context analysis guideline emphasizes conversation history review to identify components/features/patterns to document
  - AC6: Create/Update files guideline distinguishes CREATE mode (_schema.yaml) vs UPDATE mode (intelligent merge)
  - AC7: Index update guideline specifies entry structure including description field (max 100 chars one-liner)
  - AC8: Final guideline provides completion summary instead of confirmation: files created/updated, what documented, brief achievement
  - AC9: Completion summary does NOT request user confirmation - writes are executed automatically
  - AC10: Automatic related context updates preserved (guideline 6 functionality maintained)
  - AC11: Intelligent merge strategy preserved for UPDATE mode (preserve + append pattern)
  - AC12: File size threshold advisory maintained (>500 lines suggest decomposition)
  - AC13: Template remains readable with clear section breaks despite increased length
  - AC14: Terminology and phrasing consistent with /complete where workflows overlap

# ASSUMPTIONS & DEPENDENCIES

assumptions:
  - /complete v2.0 improvements are production-ready and represent best practices
  - Users will appreciate summary-based UX over confirmation-based UX
  - Template can grow to ~60-70 lines while remaining maintainable
  - Conversation history provides sufficient context for documentation (with /research suggestion as fallback)
  - Agent can detect empty/insufficient context reliably

dependencies:
  internal:
    - complete-command: "Reference for steps 3-6 workflow patterns, filename rules, completion summary format"
    - context/_schema.yaml: "Template structure for new context files (unchanged)"
    - context/_index.yaml: "Index for ID conflict checking and entry updates (add description field)"
  external: {}

# OPEN QUESTIONS

open_questions: []

# NOTES

notes: |
  Key /complete patterns to adopt:

  **Step 3 - Analyze Context Requirements** (becomes new guideline 1-2):
  - Proactive search of _index.yaml to discover existing contexts
  - Analyze conversation history to identify components/features/modules modified
  - Determine UPDATE vs CREATE for each component
  - Multiple components possible (one /document may affect multiple contexts)
  - Check existing file size (>500 lines → consider decomposition)

  **Step 4 - Generate Context Filenames** (becomes new guideline 3):
  - Use component/feature/module identity, NOT spec intent
  - Format: kebab-case, max 50 characters, no numeric or timestamp prefixes
  - Examples: authentication.yaml, build-command.yaml, error-handling.yaml
  - Validate: lowercase alphanumeric and hyphens only
  - Check for ID conflicts in _index.yaml, choose alternative if exists

  **Step 5 - Create/Update Context Files** (becomes new guideline 4):
  - For NEW: Load _schema.yaml, populate ALL fields, NEVER leave placeholders
  - For EXISTING: Read current content, preserve values (id, created), update last_updated,
    intelligently merge (add dependencies, append files, add evolution entry, append related_specs)

  **Step 6 - Update Context Index** (becomes new guideline 5):
  - For NEW: Add entry with id, file, type, description (short one-liner max 100 chars), tags
  - For EXISTING: No index update needed (entry exists)
  - Maintain YAML indentation, preserve existing entries

  **Step 9 - Present Completion Summary** (becomes new guideline 7):
  - List files created (if any) with filenames
  - List files updated (if any) with what was added
  - Brief summary of what was achieved (1-2 sentences)
  - NO confirmation request - writes already executed

  Empty context detection (new check before guidelines):
  - If conversation has minimal file reads (0-2 files) and no substantive discussion about
    components/architecture/patterns, suggest: "I notice there's limited context in our
    conversation. Would you like to run `/research [topic]` first to gather information?"

  File size threshold (integrate into guideline 4):
  - When reading existing context file, check line count
  - If >500 lines, note in summary: "Consider decomposing [filename] into smaller focused files"
  - Advisory only, not automatic

  Template growth acceptable:
  - Current: 29 lines (7 guidelines)
  - Target: ~60-70 lines (likely 7-8 restructured guidelines + empty context check)
  - Trade-off justified by UX consistency and improved robustness
